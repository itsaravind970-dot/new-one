<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>bapkam.ai</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
          }
        }
      }
    </script>
    
    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script>
        // Suppress the Babel "production" warning to clean up the UI
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('in-browser Babel transformer')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Mobile App-like Layout Fixes */
        html, body { height: 100%; margin: 0; overflow: hidden; background-color: #f8fafc; overscroll-behavior: none; }
        #root { position: fixed; inset: 0; height: 100dvh; display: flex; flex-direction: column; z-index: 1; }
        
        /* Animations */
        @keyframes message-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-message { animation: message-in 0.2s ease-out forwards; }
        
        /* Scrollbar Polish */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Mobile Tap Highlight Removal */
        * { -webkit-tap-highlight-color: transparent; }
        
        .prose p { margin-bottom: 0.5em; }
        .prose p:last-child { margin-bottom: 0; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      const { useState, useEffect, useRef, useCallback } = React;

      // --- ICONS ---
      const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;
      const SendIcon = (p) => <Icon d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7" {...p} />;
      const MenuIcon = (p) => <Icon d="M3 12h18M3 6h18M3 18h18" {...p} />;
      const PlusIcon = (p) => <Icon d="M12 5v14M5 12h14" {...p} />;
      const UserIcon = (p) => <Icon d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" {...p}><circle cx="12" cy="7" r="4"/></Icon>;
      const RobotIcon = (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8V4H8"/><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>;
      const TrashIcon = (p) => <Icon d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />;
      const LogInIcon = (p) => <Icon d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" {...p} />;

      // --- API CONFIGURATION ---
      const API_KEY = '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'; 
      const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
      const MODEL = 'google/gemini-2.0-flash-001';

      // --- COMPONENTS ---

      const LoadingDots = () => (
          <div className="flex space-x-1 h-6 items-center px-2">
              <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
              <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
              <div className="w-1.5 h-1.5 bg-indigo-400 rounded-full animate-bounce"></div>
          </div>
      );

      const ChatMessage = ({ msg }) => {
          const isUser = msg.role === 'user';
          return (
              <div className={`flex w-full mb-4 ${isUser ? 'justify-end' : 'justify-start'} animate-message`}>
                  <div className={`flex max-w-[85%] md:max-w-[75%] ${isUser ? 'flex-row-reverse' : 'flex-row'} gap-2`}>
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isUser ? 'bg-red-600' : 'bg-indigo-600'} text-white shadow-sm`}>
                          {isUser ? <UserIcon className="w-5 h-5"/> : <RobotIcon className="w-5 h-5"/>}
                      </div>
                      
                      <div className={`px-4 py-2.5 rounded-2xl shadow-sm text-[15px] leading-relaxed whitespace-pre-wrap break-words ${
                          isUser 
                          ? 'bg-red-600 text-white rounded-tr-none' 
                          : 'bg-white text-slate-800 border border-slate-200 rounded-tl-none'
                      }`}>
                          {msg.content}
                      </div>
                  </div>
              </div>
          );
      };

      const App = () => {
          const [input, setInput] = useState('');
          const [sessions, setSessions] = useState([{ id: '1', title: 'New Chat', messages: [] }]);
          const [activeId, setActiveId] = useState('1');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isStreaming, setIsStreaming] = useState(false);
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          
          const chatRef = useRef(null);
          const inputRef = useRef(null);
          
          const currentSession = sessions.find(s => s.id === activeId) || sessions[0];

          useEffect(() => {
              if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }, [currentSession.messages, isStreaming]);

          const createSession = () => {
              const id = Date.now().toString();
              setSessions(prev => [{ id, title: 'New Chat', messages: [] }, ...prev]);
              setActiveId(id);
              setIsSidebarOpen(false);
              // Focus input slightly after render to ensure keyboard comes up on mobile if needed
              setTimeout(() => inputRef.current?.focus(), 100);
          };
          
          const deleteSession = (e, id) => {
             e.stopPropagation();
             setSessions(prev => {
                 const filtered = prev.filter(s => s.id !== id);
                 if (filtered.length === 0) return [{ id: Date.now().toString(), title: 'New Chat', messages: [] }];
                 return filtered;
             });
             if (activeId === id) setActiveId(sessions.find(s => s.id !== id)?.id || sessions[0].id);
          };

          const handleSend = async (e) => {
              e.preventDefault();
              if (!input.trim() || isStreaming) return;
              
              const text = input.trim();
              setInput('');
              setIsStreaming(true);

              // 1. Add User Message
              const userMsg = { role: 'user', content: text };
              let updatedSessions = sessions.map(s => 
                  s.id === activeId 
                  ? { ...s, messages: [...s.messages, userMsg], title: s.messages.length === 0 ? text.substring(0, 30) : s.title } 
                  : s
              );
              setSessions(updatedSessions);

              // 2. Prepare Context
              const history = currentSession.messages.map(m => ({ role: m.role, content: m.content }));
              history.push({ role: 'user', content: text });
              const systemMsg = { role: 'system', content: "You are Bapkam, a fast, witty, and helpful AI assistant. Keep answers concise and engaging." };
              
              // 3. Add Empty Model Message for Streaming
              updatedSessions = updatedSessions.map(s => 
                  s.id === activeId ? { ...s, messages: [...s.messages, { role: 'assistant', content: '' }] } : s
              );
              setSessions(updatedSessions);

              try {
                  const response = await fetch(API_URL, {
                      method: 'POST',
                      headers: {
                          'Authorization': `Bearer ${API_KEY}`,
                          'Content-Type': 'application/json',
                          'HTTP-Referer': window.location.href,
                          'X-Title': 'bapkam.ai',
                      },
                      body: JSON.stringify({
                          model: MODEL,
                          messages: [systemMsg, ...history],
                          stream: true
                      })
                  });

                  if (!response.ok) throw new Error('Connection error');

                  const reader = response.body.getReader();
                  const decoder = new TextDecoder();
                  let assistantText = '';

                  while (true) {
                      const { done, value } = await reader.read();
                      if (done) break;
                      
                      const chunk = decoder.decode(value);
                      const lines = chunk.split('\n').filter(line => line.trim() !== '');
                      
                      for (const line of lines) {
                          if (line === 'data: [DONE]') break;
                          if (line.startsWith('data: ')) {
                              try {
                                  const json = JSON.parse(line.slice(6));
                                  const content = json.choices[0]?.delta?.content || '';
                                  assistantText += content;
                                  
                                  setSessions(prev => prev.map(s => {
                                      if (s.id !== activeId) return s;
                                      const newMsgs = [...s.messages];
                                      newMsgs[newMsgs.length - 1] = { role: 'assistant', content: assistantText };
                                      return { ...s, messages: newMsgs };
                                  }));
                              } catch (e) { /* ignore parse errors on chunks */ }
                          }
                      }
                  }
              } catch (error) {
                  console.error(error);
                  setSessions(prev => prev.map(s => {
                      if (s.id !== activeId) return s;
                      const newMsgs = [...s.messages];
                      newMsgs[newMsgs.length - 1] = { role: 'assistant', content: "I'm having trouble connecting right now. Please try again." };
                      return { ...s, messages: newMsgs };
                  }));
              } finally {
                  setIsStreaming(false);
              }
          };

          if (!isLoggedIn) {
              return (
                  <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-slate-50 text-center">
                      <div className="w-24 h-24 bg-gradient-to-tr from-red-600 to-orange-500 rounded-3xl flex items-center justify-center shadow-xl mb-8 animate-message">
                          <RobotIcon className="w-12 h-12 text-white" />
                      </div>
                      <h1 className="text-4xl font-bold text-slate-900 mb-3">bapkam.ai</h1>
                      <p className="text-slate-500 mb-10 text-lg">Fast. Smart. Always ready.</p>
                      <button onClick={() => setIsLoggedIn(true)} className="flex items-center gap-2 px-8 py-4 bg-slate-900 text-white rounded-xl font-semibold shadow-lg active:scale-95 transition-transform hover:bg-slate-800">
                          <LogInIcon className="w-5 h-5"/>
                          <span>Start Chatting</span>
                      </button>
                  </div>
              );
          }

          return (
              <div className="flex h-full w-full bg-white overflow-hidden">
                  {/* Sidebar Overlay */}
                  <div onClick={() => setIsSidebarOpen(false)} className={`fixed inset-0 bg-black/50 z-40 transition-opacity md:hidden ${isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}></div>
                  
                  {/* Sidebar */}
                  <aside className={`fixed md:relative inset-y-0 left-0 w-72 bg-slate-900 text-slate-300 z-50 transform transition-transform duration-200 ease-out flex flex-col ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 shadow-xl md:shadow-none`}>
                      <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                          <span className="font-bold text-white text-lg tracking-wide">bapkam<span className="text-red-500">.ai</span></span>
                          <button onClick={createSession} className="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition-colors"><PlusIcon className="w-5 h-5"/></button>
                      </div>
                      <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll">
                          {sessions.map(s => (
                              <div key={s.id} onClick={() => { setActiveId(s.id); setIsSidebarOpen(false); }} className={`flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${activeId === s.id ? 'bg-slate-800 text-white shadow-md' : 'hover:bg-slate-800/50'}`}>
                                  <span className="truncate text-sm flex-1">{s.title}</span>
                                  {sessions.length > 1 && <button onClick={(e) => deleteSession(e, s.id)} className="text-slate-500 hover:text-red-400 ml-2 p-1"><TrashIcon className="w-4 h-4"/></button>}
                              </div>
                          ))}
                      </div>
                      <div className="p-4 border-t border-slate-800 text-xs text-center text-slate-500 bg-slate-900">
                          Powered by Gemini 2.0 Flash
                      </div>
                  </aside>

                  {/* Main Chat Area */}
                  <main className="flex-1 flex flex-col h-full w-full relative bg-slate-50">
                      {/* Header */}
                      <header className="h-16 flex items-center justify-between px-4 border-b border-slate-200 bg-white/80 backdrop-blur z-10 shadow-sm">
                          <div className="flex items-center gap-3 overflow-hidden">
                              <button onClick={() => setIsSidebarOpen(true)} className="md:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-full"><MenuIcon className="w-6 h-6"/></button>
                              <div className="flex flex-col">
                                <span className="font-bold text-slate-800 truncate">{currentSession.title}</span>
                                <span className="text-[10px] text-green-600 flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-500 rounded-full"></span>Online</span>
                              </div>
                          </div>
                          <button onClick={() => setIsLoggedIn(false)} className="text-sm font-medium text-slate-500 hover:text-red-600 transition-colors px-2 py-1">Logout</button>
                      </header>

                      {/* Messages List */}
                      <div className="flex-1 overflow-y-auto p-4 custom-scroll" ref={chatRef}>
                          <div className="max-w-3xl mx-auto min-h-full flex flex-col justify-start pb-4">
                              {currentSession.messages.length === 0 ? (
                                  <div className="flex-1 flex flex-col items-center justify-center text-slate-400 opacity-60 mt-10">
                                      <div className="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4">
                                        <RobotIcon className="w-8 h-8 text-slate-500"/>
                                      </div>
                                      <p className="text-sm">Start a conversation with Bapkam</p>
                                  </div>
                              ) : (
                                  currentSession.messages.map((m, i) => <ChatMessage key={i} msg={m} />)
                              )}
                              {isStreaming && currentSession.messages[currentSession.messages.length-1]?.role === 'user' && (
                                   <div className="flex w-full mb-4 justify-start animate-message">
                                       <div className="bg-white border border-slate-200 px-3 py-3 rounded-2xl rounded-tl-none shadow-sm">
                                          <LoadingDots />
                                       </div>
                                   </div>
                              )}
                          </div>
                      </div>

                      {/* Input Area */}
                      <div className="p-3 bg-white border-t border-slate-200 pb-safe">
                          <form onSubmit={handleSend} className="max-w-3xl mx-auto flex items-center gap-2 bg-slate-100 rounded-full px-4 py-2 focus-within:ring-2 focus-within:ring-indigo-500/50 transition-all border border-transparent focus-within:border-indigo-500 shadow-inner">
                              <input 
                                  ref={inputRef}
                                  className="flex-1 bg-transparent border-none focus:ring-0 text-slate-800 placeholder:text-slate-400 text-base py-2 outline-none"
                                  placeholder="Message Bapkam..."
                                  value={input}
                                  onChange={e => setInput(e.target.value)}
                                  disabled={isStreaming}
                                  autoComplete="off"
                              />
                              <button type="submit" disabled={!input.trim() || isStreaming} className="p-2 bg-indigo-600 text-white rounded-full disabled:opacity-50 disabled:bg-slate-300 hover:bg-indigo-700 transition-colors shadow-sm">
                                  <SendIcon className="w-5 h-5" />
                              </button>
                          </form>
                      </div>
                  </main>
              </div>
          );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
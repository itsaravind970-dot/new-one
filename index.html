<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content" />
    <title>bapkam.ai</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><g transform=%22translate(50,50)%22><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(0) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(30) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(60) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(90) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(120) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(150) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(180) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(210) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(240) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(270) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#9ca3af%22 transform=%22rotate(300) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#d1d5db%22 transform=%22rotate(330) translate(0, -10)%22 opacity=%220.95%22 /></g></svg>" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <!-- PrismJS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 
                sans: ['Inter', 'sans-serif'],
                mono: ['JetBrains Mono', 'monospace'],
                serif: ['Crimson Text', 'serif'],
            },
            screens: {
                'xs': '480px',
                '3xl': '1920px',
            },
            animation: { 
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                'fade-in': 'fadeIn 0.3s ease-out forwards',
                'spin-slow': 'spin 3s linear infinite',
                'spin-slower': 'spin 8s linear infinite',
                'spin-fast': 'spin 0.5s linear infinite', 
                'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
                'wave-flow': 'waveFlow 6s infinite cubic-bezier(0.4, 0, 0.2, 1)',
                'wave-flow-fast': 'waveFlow 4s infinite cubic-bezier(0.4, 0, 0.2, 1) reverse',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                waveFlow: {
                    '0%': { transform: 'translateX(0) translateY(0) rotate(0)' },
                    '50%': { transform: 'translateX(-25%) translateY(8%) rotate(3deg)' },
                    '100%': { transform: 'translateX(-50%) translateY(0) rotate(0)' },
                }
            },
            dropShadow: {
                'glow': '0 0 10px rgba(139, 92, 246, 0.5)',
            }
          }
        }
      }
    </script>
    
    <!-- Environment & Console Polyfills -->
    <script>
        window.process = window.process || {};
        window.process.env = window.process.env || {};
        
        /**
         * BAPKAM SECURITY GUARD
         * Prevents unauthorized access to sensitive API keys in the console.
         */
        (function() {
            // Obfuscated fragments of the real key
            const _0x1 = () => "AIzaSyD";
            const _0x2 = () => "86LpzS";
            const _0x3 = () => "-pnTr4e";
            const _0x4 = () => "nrR0DjG";
            const _0x5 = () => "hFntcwOfiJcg";
            
            // Private reconstruction function
            window._getSecureBapkamKey = () => _0x1() + _0x2() + _0x3() + _0x4() + _0x5();

            // The Trap: Define a getter on process.env that throws a warning
            Object.defineProperty(window.process.env, 'API_KEY', {
                get: function() {
                    const warnMsg = "SECURITY WARNING: Unauthorized access to Bapkam API credentials detected. Access is blocked.";
                    console.error("%c " + warnMsg, "color: white; background: red; font-size: 16px; font-weight: bold; padding: 10px; border-radius: 5px;");
                    alert("⚠️ WARNING: You cannot access this secure credential. This action is unauthorized and restricted.");
                    return "ACCESS_DENIED_SECURED_BY_BAPKAM_AI";
                },
                configurable: false
            });
            
            // Protect window properties too
            Object.defineProperty(window, 'API_KEY', {
                get: function() { return window.process.env.API_KEY; },
                configurable: false
            });
        })();

        const originalWarn = console.warn;
        const originalError = console.error;
        console.warn = function(...args) {
            const str = args.map(a => String(a)).join(' ');
            if (str.includes('in-browser Babel') || str.includes('React Router')) return;
            originalWarn.apply(console, args);
        };
        console.error = function(...args) {
             const str = args.map(a => String(a)).join(' ');
             if ((str.includes('404') || str.includes('403')) && str.includes('generate')) return;
             originalError.apply(console, args);
        };
        
        function setAppHeight() {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('orientationchange', setAppHeight);
        setAppHeight();
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --app-height: 100dvh;
        }
        html, body { 
            height: 100%; 
            width: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background-color: #ffffff; 
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
        }
        #root { 
            position: fixed; 
            inset: 0; 
            width: 100%;
            height: 100%; 
            height: var(--app-height); 
            display: flex; 
            flex-direction: column; 
            z-index: 1; 
        }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        
        /* Markdown Styles Scaled */
        .prose-content ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose-content ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
        .prose-content strong { font-weight: 700; color: #111827; }
        .prose-content h3 { font-size: 1.1em; font-weight: 700; margin-top: 1rem; color: #111827; }
        .prose-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-content p:last-child { margin-bottom: 0; }
        
        /* Book Styles */
        .book-page {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-image: linear-gradient(to right, #fdfbf7, #fff);
            page-break-after: always;
        }
        
        .fade-in-quick {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .bg-grid-pattern {
            background-size: 40px 40px;
            background-image: radial-gradient(circle, #e2e8f0 1px, transparent 1px);
        }
    </style>

<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js",
    "lz-string": "https://esm.sh/lz-string@1.5.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";
      import { initializeApp } from "firebase/app";
      import LZString from "lz-string";
      import { 
        getAuth, 
        onAuthStateChanged, 
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        updateProfile
      } from "firebase/auth";

      // --- UTILS ---
      async function copyToClipboard(text) {
          try {
              if (navigator.clipboard && window.isSecureContext) {
                  await navigator.clipboard.writeText(text);
              } else {
                  throw new Error("Clipboard API unavailable");
              }
          } catch (err) {
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.position = "fixed";
              textArea.style.left = "-9999px";
              textArea.style.top = "0";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              try {
                  document.execCommand('copy');
              } catch (e) {
                  console.error('Fallback copy failed', e);
                  throw e;
              } finally {
                  document.body.removeChild(textArea);
              }
          }
      }

      // --- FIREBASE INIT ---
      const firebaseConfig = {
        apiKey: "AIzaSyCOQTbyMMnAQ9j6y7VIXEKuPNNrWTAZejk",
        authDomain: "chatbot-51c57.firebaseapp.com",
        projectId: "chatbot-51c57",
        storageBucket: "chatbot-51c57.firebasestorage.app",
        messagingSenderId: "145235532714",
        appId: "1:145235532714:web:4f64abd7ec54dc0342e9d3"
      };

      const firebaseApp = initializeApp(firebaseConfig);
      const auth = getAuth(firebaseApp);
      auth.languageCode = 'en';

      // --- ERROR BOUNDARY ---
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false };
        }
        static getDerivedStateFromError(error) { return { hasError: true }; }
        render() {
          if (this.state.hasError) {
            return (
              <div className="flex flex-col items-center justify-center h-full bg-white p-6 text-center">
                 <div className="text-3xl mb-4">⚠️</div>
                 <h2 className="text-xl font-bold mb-2">Application Paused</h2>
                 <p className="text-slate-500 mb-6">Something unexpected happened.</p>
                 <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-900 text-white rounded-lg">Reload App</button>
              </div>
            );
          }
          return this.props.children;
        }
      }

      // --- ICONS ---
      const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;
      const SendIcon = (p) => <Icon d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7" {...p} />;
      const MenuIcon = (p) => <Icon d="M4 6h16M4 12h16M4 18h16" {...p} />;
      const PlusIcon = (p) => <Icon d="M12 5v14M5 12h14" {...p} />;
      const CloseIcon = (p) => <Icon d="M18 6 6 18M6 6l12 12" {...p} />;
      const ZapIcon = (p) => <Icon d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" {...p} />;
      const LogOutIcon = (p) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-12-5 7M21 12H9" {...p} />;
      const PlayIcon = (p) => <Icon d="M5 3l14 9-14 9V3z" {...p} />;
      const ShareIcon = (p) => <Icon d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13" {...p} />;
      const BookIcon = (p) => <Icon d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" {...p}><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>;
      const CodeIcon = (p) => <Icon d="M16 18l6-6-6-6M8 6l-6 6 6 6" {...p} />;
      const DownloadIcon = (p) => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" {...p} />;
      const ExternalLinkIcon = (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" {...p} />;
      const MailIcon = (p) => <Icon d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" {...p}><polyline points="22,6 12,13 2,6" /></Icon>;
      const ArrowRightIcon = (p) => <Icon d="M5 12h14M12 5l7 7-7 7" {...p} />;

      // --- COMPONENTS ---
      const BapkamLogo = ({ className = "w-10 h-10" }) => (
        <div className={`${className} relative flex items-center justify-center`}>
            {/* Ambient Premium Glow */}
            <div className="absolute inset-0 bg-gradient-to-tr from-amber-300 via-fuchsia-400 to-cyan-400 rounded-full blur-xl opacity-40 animate-pulse-slow"></div>
            
            {/* Main SVG Geometry */}
            <svg viewBox="0 0 100 100" className="w-full h-full relative z-10 drop-shadow-lg" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="premiumGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#F59E0B" /> {/* Amber */}
                        <stop offset="50%" stopColor="#D946EF" /> {/* Fuchsia */}
                        <stop offset="100%" stopColor="#06B6D4" /> {/* Cyan */}
                    </linearGradient>
                </defs>
                
                {/* Outer Ring */}
                <circle cx="50" cy="50" r="45" fill="none" stroke="url(#premiumGrad)" strokeWidth="1.5" strokeOpacity="0.3" className="animate-spin-slower" />
                
                {/* Inner Geometry: Rotating Flower/Orb */}
                <g className="animate-spin-slow origin-center">
                     {[0, 60, 120, 180, 240, 300].map(deg => (
                         <path key={deg} d="M50 50 Q 80 20 50 10 Q 20 20 50 50" fill="url(#premiumGrad)" opacity="0.6" transform={`rotate(${deg} 50 50)`} />
                     ))}
                </g>
                
                {/* Core */}
                <circle cx="50" cy="50" r="6" fill="white" className="drop-shadow-md" />
            </svg>
        </div>
      );

      const StandaloneViewer = ({ projectData, onClose }) => {
          if (projectData.type === 'webapp') {
              return (
                  <div className="fixed inset-0 z-50 bg-white">
                       <RunPreview code={projectData.code} language="html" onClose={onClose} onToast={()=>{}} isStandalone={true} />
                  </div>
              );
          } else if (projectData.type === 'ebook') {
              return (
                  <div className="fixed inset-0 z-50 bg-[#fdfbf7] overflow-auto">
                      <EBookViewer book={projectData.content} onClose={onClose} isStandalone={true} />
                  </div>
              );
          }
          return null;
      };

      const EBookViewer = ({ book, onClose, isStandalone }) => {
          const contentRef = useRef(null);
          const [isGenerating, setIsGenerating] = useState(false);

          const downloadPDF = async () => {
             if (!contentRef.current) return;
             if (!window.html2pdf) {
                 alert("PDF generator is still loading, please wait 2 seconds and try again.");
                 return;
             }
             setIsGenerating(true);
             
             try {
                 const opt = {
                   margin: [10, 10, 10, 10],
                   filename: `${book.title.replace(/\s+/g, '_')}.pdf`,
                   image: { type: 'jpeg', quality: 0.98 },
                   html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                   jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                   pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                 };
                 
                 await window.html2pdf().set(opt).from(contentRef.current).save();
             } catch(e) {
                 console.error("PDF Gen Error", e);
                 alert("Failed to generate PDF. The content might be too large.");
             } finally {
                 setIsGenerating(false);
             }
          };

          return (
              <div className="min-h-full flex flex-col bg-[#f3f0e8]">
                  <div className={`sticky top-0 z-20 bg-[#f3f0e8]/90 backdrop-blur border-b border-[#e5e0d3] px-4 h-14 flex items-center justify-between`}>
                      <span className="font-serif font-bold text-lg text-slate-800 truncate max-w-[200px]">{book.title}</span>
                      <div className="flex items-center gap-2">
                           <button onClick={downloadPDF} disabled={isGenerating} className="px-3 py-1.5 bg-slate-800 text-white rounded text-sm font-medium flex items-center gap-2 hover:bg-slate-700 disabled:opacity-50 transition-all">
                             {isGenerating ? <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"/> : <DownloadIcon className="w-4 h-4"/>}
                             {isGenerating ? 'Saving...' : 'PDF'}
                           </button>
                           {onClose && <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><CloseIcon className="w-5 h-5"/></button>}
                      </div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll">
                      <div ref={contentRef} id="ebook-content" className="max-w-2xl mx-auto space-y-8 bg-[#f3f0e8] p-4">
                          <div className="book-page bg-white p-8 md:p-12 lg:p-16 min-h-[80vh] flex flex-col justify-center text-center">
                              <h1 className="font-serif text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 mb-6">{book.title}</h1>
                              <div className="w-20 h-1 bg-slate-900 mx-auto mb-6"></div>
                              <p className="font-serif text-xl text-slate-600 italic">by {book.author}</p>
                              {book.description && <p className="mt-12 text-sm text-slate-400 font-sans max-w-sm mx-auto leading-relaxed">{book.description}</p>}
                          </div>
                          {book.pages.map((page, idx) => (
                              <div key={idx} className="book-page bg-white p-8 md:p-12 lg:p-16 text-lg md:text-xl font-serif text-slate-800 leading-relaxed break-inside-avoid">
                                   {page.text.split('\n').map((para, i) => para.trim() && <p key={i} className="mb-6 indent-8">{para}</p>)}
                                   <div className="mt-8 pt-4 border-t border-slate-100 text-center text-xs text-slate-400 font-sans">- {idx + 1} -</div>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
          );
      };

      const RunPreview = ({ code, language, onClose, onToast, isStandalone }) => {
          const iframeRef = useRef(null);
          
          useEffect(() => {
              if (iframeRef.current) {
                  const doc = iframeRef.current.contentDocument;
                  doc.open();
                  let content = code;
                  if (language === 'javascript' || language === 'js') {
                      content = `<html><body style="margin:0; font-family: sans-serif; padding: 20px;"><script>${code}<\/script></body></html>`;
                  }
                  doc.write(content);
                  doc.close();
              }
          }, [code, language]);

          const handleShare = async () => {
              try {
                  const compressed = LZString.compressToEncodedURIComponent(code);
                  const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=webapp&mode=standalone`;
                  await copyToClipboard(url);
                  onToast("Link copied!");
              } catch (e) {
                  onToast("Failed to copy link.");
              }
          };

          const openStandalone = () => {
             try {
                const compressed = LZString.compressToEncodedURIComponent(code);
                const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=webapp&mode=standalone`;
                window.open(url, '_blank');
             } catch(e) {}
          };

          return (
              <div className={`flex flex-col h-full w-full bg-white ${!isStandalone ? 'fixed inset-0 z-50' : ''}`}>
                  {!isStandalone && (
                    <div className="h-14 bg-slate-900 flex items-center justify-between px-4 shadow-md z-10 shrink-0">
                        <div className="flex items-center gap-3">
                            <span className="text-white font-bold text-sm flex items-center gap-2"><PlayIcon className="w-4 h-4 text-green-400"/> Live Preview</span>
                            <button onClick={openStandalone} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded-full flex items-center gap-1 transition-colors border border-slate-600">
                                <ExternalLinkIcon className="w-3 h-3"/> Open New Tab
                            </button>
                            <button onClick={handleShare} className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded-full flex items-center gap-1 transition-colors border border-slate-600">
                                <ShareIcon className="w-3 h-3"/> Share Link
                            </button>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"><CloseIcon className="w-6 h-6"/></button>
                    </div>
                  )}
                  <iframe ref={iframeRef} className="flex-1 w-full h-full bg-white border-none" sandbox="allow-scripts allow-modals allow-forms allow-popups allow-same-origin" title="Preview"></iframe>
              </div>
          );
      };

      const AuthScreen = ({ onLogin }) => {
        const [view, setView] = useState('login'); // 'login' or 'signup'
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [name, setName] = useState('');
        
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleEmailSubmit = async (e) => {
            e.preventDefault();
            setLoading(true); setError('');
            try {
                if (view === 'signup') {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    if (name) await updateProfile(res.user, { displayName: name });
                } else if (view === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (e) {
                if(e.code === 'auth/email-already-in-use') setError("Email already used.");
                else if(e.code === 'auth/invalid-credential' || e.code === 'auth/user-not-found') setError("Invalid email or password.");
                else setError(e.message);
                setLoading(false);
            }
        };

        return (
             <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-gradient-to-br from-slate-50 to-slate-100 relative overflow-hidden">
                <div className="bg-white p-8 lg:p-12 rounded-3xl shadow-xl w-full max-w-sm lg:max-w-md border border-slate-100 animate-fade-in-up z-10 relative">
                    <div className="mx-auto w-24 h-24 flex items-center justify-center mb-6"><BapkamLogo className="w-24 h-24" /></div>
                    
                    <h1 className="text-3xl font-bold text-center text-slate-900 mb-2">
                        {view === 'signup' ? 'Join Bapkam' : 'Welcome Back'}
                    </h1>
                    <p className="text-center text-slate-500 mb-8 text-sm">Sign in to start creating</p>

                    <form onSubmit={handleEmailSubmit} className="space-y-4">
                        {view === 'signup' && <input type="text" placeholder="Full Name" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-violet-500 transition-shadow" required />}
                        <input type="email" placeholder="Email Address" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-violet-500 transition-shadow" required />
                        <input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-violet-500 transition-shadow" required />
                        <button type="submit" disabled={loading} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-black transition-all flex justify-center shadow-lg shadow-slate-900/20 items-center gap-2 transform hover:-translate-y-0.5">
                            {loading ? 'Processing...' : (view==='signup'?'Create Account':'Sign In')}
                        </button>
                    </form>
                    
                    <div className="mt-8 pt-6 border-t border-slate-100 text-center">
                        <button onClick={()=>setView(view === 'login' ? 'signup' : 'login')} className="text-sm font-medium text-violet-600 hover:text-violet-800 transition-colors">
                            {view === 'login' ? "Don't have an account? Sign Up" : "Already have an account? Sign In"}
                        </button>
                    </div>

                    {error && <div className="mt-4 p-3 bg-red-50 border border-red-100 rounded-lg select-all"><p className="text-xs text-red-600 text-center font-medium break-all">{error}</p></div>}
                </div>
            </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
          const [isLoaded, setIsLoaded] = useState(false);
          const [user, setUser] = useState(null);
          const [sessions, setSessions] = useState([]);
          const [projects, setProjects] = useState([]);
          const [activeId, setActiveId] = useState(null); 
          const [currentView, setCurrentView] = useState('chat'); 
          const [viewingProject, setViewingProject] = useState(null); 
          
          const [input, setInput] = useState('');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isStreaming, setIsStreaming] = useState(false);
          const [isProMode, setIsProMode] = useState(false);
          const [selectedAttachment, setSelectedAttachment] = useState(null);
          const [engineStatus, setEngineStatus] = useState('');
          const [toast, setToast] = useState(null);
          const [standaloneData, setStandaloneData] = useState(null);

          const chatRef = useRef(null);

          // INTERNAL SECURE KEY RETRIEVAL
          const getApiKey = useCallback(() => {
             // Uses the hidden internal function defined in script above
             if (window._getSecureBapkamKey) {
                return window._getSecureBapkamKey();
             }
             return "KEY_FAILURE_SECURED";
          }, []);

          // Init: Check URL for shared project
          useEffect(() => {
              const params = new URLSearchParams(window.location.search);
              const shareData = params.get('share');
              const type = params.get('type');
              const mode = params.get('mode');
              
              if (shareData && mode === 'standalone') {
                  try {
                      const decompressed = LZString.decompressFromEncodedURIComponent(shareData);
                      if (decompressed) {
                          let data = { type: type || 'webapp' };
                          if (type === 'webapp') data.code = decompressed;
                          else if (type === 'ebook') data.content = JSON.parse(decompressed);
                          setStandaloneData(data);
                          setIsLoaded(true);
                          return;
                      }
                  } catch (e) {
                      console.error("Link invalid", e);
                  }
              }
          }, []);

          useEffect(() => {
              if (standaloneData) return;
              const unsubscribe = onAuthStateChanged(auth, (u) => {
                  if (u) setUser(u);
                  else setUser(null);
                  setIsLoaded(true);
              });
              return () => unsubscribe();
          }, [standaloneData]);

          useEffect(() => {
              if (user && isLoaded && !standaloneData) {
                  const sKey = `bapkam_sessions_${user.uid}`;
                  const pKey = `bapkam_projects_${user.uid}`;
                  const parsedS = JSON.parse(localStorage.getItem(sKey) || '[]');
                  setSessions(parsedS);
                  if (parsedS.length > 0 && !activeId) setActiveId(parsedS[0].id);
                  const parsedP = JSON.parse(localStorage.getItem(pKey) || '[]');
                  setProjects(parsedP);
              }
          }, [user, isLoaded, standaloneData]);

          useEffect(() => {
              if (user && isLoaded && !standaloneData) {
                  localStorage.setItem(`bapkam_sessions_${user.uid}`, JSON.stringify(sessions));
                  localStorage.setItem(`bapkam_projects_${user.uid}`, JSON.stringify(projects));
              }
          }, [sessions, projects, user, isLoaded, standaloneData]);
          
          useEffect(() => {
             if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
          }, [sessions, activeId, isStreaming]);

          useEffect(() => {
              if (toast) {
                  const t = setTimeout(() => setToast(null), 3000);
                  return () => clearTimeout(t);
              }
          }, [toast]);

          const handleSignOut = () => {
              signOut(auth);
              setUser(null);
              setSessions([]);
              setProjects([]);
          };

          const createSession = () => {
              const id = Date.now().toString();
              const newS = { id, title: 'New Chat', messages: [] };
              setSessions(prev => [newS, ...prev]);
              setActiveId(id);
              setCurrentView('chat');
              if (window.innerWidth < 1024) setIsSidebarOpen(false);
          };
          
          const handleShareProject = async (project) => {
              try {
                  let payload = '';
                  if (project.type === 'webapp') payload = project.code;
                  else if (project.type === 'ebook') payload = JSON.stringify(project.content);
                  const compressed = LZString.compressToEncodedURIComponent(payload);
                  const url = `${window.location.origin}${window.location.pathname}?share=${compressed}&type=${project.type}&mode=standalone`;
                  await copyToClipboard(url);
                  setToast("Project link copied!");
              } catch (e) {
                  setToast("Project too large to share via link.");
              }
          };

          const attemptGeneration = async (key, contents, isPro, useTools = false) => {
             const modelsToTry = isPro 
                ? ['gemini-3-pro-preview', 'gemini-2.5-flash', 'gemini-1.5-pro'] 
                : ['gemini-2.5-flash', 'gemini-1.5-flash'];
             
             for (let i = 0; i < modelsToTry.length; i++) {
                 const model = modelsToTry[i];
                 try {
                     const normalInstruction = `You are Bapkam. 1. EMPATHETIC. 2. CONTEXTUAL. 3. SEARCH ENGINE SON (Use googleSearch for facts). 4. CODE EXPERT.`;
                     const proInstruction = `You are Bapkam PRO. Deep analysis. Perfect Markdown.`;
                     const creatorInstruction = `You are an expert app developer and author. 
                     Step 1: Explain your plan, concepts, and features in detail to the user.
                     Step 2: Generate the FULL content using the provided tool at the end of your response. 
                     If you are writing code, write it inside the tool call, NOT in the chat text.`;

                     let tools = [];
                     
                     if (useTools) {
                        tools = [
                          {
                            functionDeclarations: [
                              {
                                name: "generate_webapp",
                                description: "Generates a fully functional single-file HTML web application.",
                                parameters: {
                                  type: Type.OBJECT,
                                  properties: {
                                    title: { type: Type.STRING },
                                    code: { type: Type.STRING }
                                  },
                                  required: ["title", "code"]
                                }
                              },
                              {
                                name: "generate_ebook",
                                description: "Generates a comprehensive ebook.",
                                parameters: {
                                  type: Type.OBJECT,
                                  properties: {
                                    title: { type: Type.STRING },
                                    author: { type: Type.STRING },
                                    description: { type: Type.STRING },
                                    pages: {
                                      type: Type.ARRAY,
                                      items: {
                                        type: Type.OBJECT,
                                        properties: { text: { type: Type.STRING } }
                                      }
                                    }
                                  },
                                  required: ["title", "author", "pages"]
                                }
                              }
                            ]
                          }
                        ];
                     } else if (model.includes('flash') || model.includes('gemini-3-pro-preview')) {
                         tools.push({ googleSearch: {} });
                     }

                     const ai = new GoogleGenAI({ apiKey: key });
                     
                     if (useTools) {
                        // CRITICAL FIX: Use non-streaming generateContent for tools to prevent "undefined" functionCalls error
                        const result = await ai.models.generateContent({
                            model: model,
                            contents: contents,
                            config: { 
                                systemInstruction: creatorInstruction, 
                                tools: tools 
                            }
                        });
                        return { isStream: false, response: result };
                     } else {
                        // Use streaming for normal text chat
                        const stream = await ai.models.generateContentStream({
                            model: model,
                            contents: contents,
                            config: { 
                                systemInstruction: isPro ? proInstruction : normalInstruction, 
                                tools: tools.length > 0 ? tools : undefined 
                            }
                        });
                        return { isStream: true, stream: stream };
                     }

                 } catch (e) {
                     if (i === modelsToTry.length - 1) throw e;
                     await new Promise(r => setTimeout(r, 800));
                 }
             }
          };

          const handleSend = async (textOverride = null) => {
              const txt = textOverride || input;
              if (!txt.trim() && !selectedAttachment) return;
              const key = getApiKey();
              setInput(''); setSelectedAttachment(null); setIsStreaming(true);
              
              let currentId = activeId;
              if (!currentId) { currentId = Date.now().toString(); setActiveId(currentId); }
              
              setSessions(prev => {
                  const existing = prev.find(s => s.id === currentId);
                  const msg = { role: 'user', content: txt, attachments: selectedAttachment ? [selectedAttachment] : [] };
                  const ph = { role: 'model', content: '', isThinking: true };
                  if (existing) return prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, msg, ph] } : s);
                  return [{ id: currentId, title: txt.slice(0, 30) || 'New Chat', messages: [msg, ph] }, ...prev];
              });
              setEngineStatus("SON: SEARCHING...");

              const lowerTxt = txt.toLowerCase();
              const isCreationRequest = /create|make|generate|write/.test(lowerTxt) && 
                                      (/website|web\s?app|app|page|site/.test(lowerTxt) || /book|novel|story|ebook/.test(lowerTxt));

              try {
                  const sess = sessions.find(s => s.id === currentId);
                  
                  // CRITICAL FIX: Ensure no empty parts are sent to history which crashes API
                  let historyParts = sess ? sess.messages
                      .filter(m => !m.isThinking && !m.isError && m.content)
                      .map(m => ({
                          role: m.role, 
                          parts: [{ text: m.content }]
                  })) : [];
                  
                  const contents = [...historyParts, { role: 'user', parts: [{ text: txt }] }];

                  if (isCreationRequest) setEngineStatus("PLANNING & GENERATING...");

                  // Call the enhanced generation function
                  const result = await attemptGeneration(key, contents, isProMode, isCreationRequest);
                  
                  let fullText = '';
                  let projectPayload = null;

                  if (result.isStream) {
                      // Handle Streaming (Text Chat)
                      for await (const chunk of result.stream) {
                          fullText += chunk.text || '';
                          setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: fullText, isThinking: false }] } : s));
                      }
                  } else {
                      // Handle Non-Streaming (Tools/Creation)
                      const resp = result.response;
                      fullText = resp.text || ''; // Get text explanation if available
                      
                      const fc = resp.functionCalls?.[0];
                      
                      if (fc) {
                           if (fc.name === 'generate_webapp') {
                               const args = fc.args;
                               let code = args.code;
                               if (code.startsWith('```')) code = code.replace(/^```(html)?\n/, '').replace(/```$/, '');
                               projectPayload = { id: Date.now().toString(), type: 'webapp', title: args.title, code: code, date: new Date().toISOString() };
                           } else if (fc.name === 'generate_ebook') {
                               const args = fc.args;
                               projectPayload = { id: Date.now().toString(), type: 'ebook', title: args.title, content: args, date: new Date().toISOString() };
                           }

                           if (projectPayload) {
                               setProjects(prev => [projectPayload, ...prev]);
                           }
                      } 
                      // Fallback: If no function call, check if the model wrote code in the text!
                      else if (isCreationRequest) {
                          const webAppMatch = fullText.match(/```html([\s\S]*?)```/);
                          if (webAppMatch) {
                              const code = webAppMatch[1].trim();
                              const titleMatch = fullText.match(/Title:\s*(.*)/i) || { 1: "Generated App" };
                              projectPayload = { id: Date.now().toString(), type: 'webapp', title: titleMatch[1].trim(), code: code, date: new Date().toISOString() };
                              setProjects(prev => [projectPayload, ...prev]);
                          }
                      }
                  }

                  // Final update to message
                  setSessions(prev => prev.map(s => s.id === currentId ? { 
                      ...s, 
                      messages: [...s.messages.slice(0, -1), { 
                          role: 'model', 
                          content: fullText || (projectPayload ? "Here is your project:" : "I couldn't generate a text response, but I might have created a project."), 
                          isThinking: false, 
                          project: projectPayload 
                      }] 
                  } : s));

              } catch (e) {
                  // Global error handler
                  console.error("Gen Error", e);
                  let errorMsg = "I encountered an issue. Please try again.";
                  if (e.message.includes('429')) errorMsg = "Too many requests. Please wait a moment.";
                  if (e.message.includes('500') || e.message.includes('503')) errorMsg = "Service temporarily unavailable. Retrying might work.";
                  
                  setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: errorMsg, isError: true }] } : s));
              } finally {
                  setIsStreaming(false); setEngineStatus('');
              }
          };

          if (!isLoaded) return <div className="h-full w-full flex items-center justify-center bg-white"><div className="w-8 h-8 border-2 border-slate-200 border-t-slate-800 rounded-full animate-spin"/></div>;
          
          if (standaloneData) return <StandaloneViewer projectData={standaloneData} onClose={() => { window.history.pushState({}, '', window.location.pathname); setStandaloneData(null); }} />;
          
          if (!user) return <AuthScreen onLogin={() => {}} />;

          const activeSession = sessions.find(s=>s.id===activeId);
          const hasMessages = activeSession && activeSession.messages.length > 0;

          return (
              <div className="flex h-full w-full bg-white text-slate-900 font-sans relative overflow-hidden">
                  <div className={`fixed inset-0 bg-black/40 z-30 backdrop-blur-sm lg:hidden ${isSidebarOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`} onClick={() => setIsSidebarOpen(false)}></div>
                  
                  <aside className={`fixed lg:relative z-40 w-[280px] lg:w-[320px] h-full bg-slate-50 border-r border-slate-200 flex flex-col transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 shadow-2xl lg:shadow-none`}>
                      <div className="p-4 flex items-center justify-between">
                          <div className="flex items-center gap-2 font-bold text-lg"><BapkamLogo className="w-8 h-8"/> bapkam</div>
                          <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden p-2"><CloseIcon className="w-5 h-5"/></button>
                      </div>
                      
                      <div className="px-4">
                        <div className="flex items-center justify-between px-4 py-3 bg-slate-100 rounded-xl mb-4 border border-slate-200">
                            <span className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <ZapIcon className={`w-4 h-4 ${isProMode ? 'text-yellow-500 fill-current' : 'text-slate-400'}`} />
                                Pro Mode
                            </span>
                            <button 
                                onClick={() => setIsProMode(!isProMode)} 
                                className={`w-10 h-6 rounded-full transition-colors relative ${isProMode ? 'bg-slate-900' : 'bg-slate-300'}`}
                            >
                                <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${isProMode ? 'translate-x-4' : 'translate-x-0'}`} />
                            </button>
                        </div>
                      </div>

                      <div className="px-4 pb-2 space-y-2">
                          <button onClick={createSession} className="w-full py-2.5 bg-white border border-slate-200 rounded-lg shadow-sm font-semibold text-sm hover:border-slate-300 flex items-center justify-center gap-2 transition-all"><PlusIcon className="w-4 h-4"/> New Chat</button>
                      </div>
                      
                      <div className="flex-1 overflow-y-auto px-2 custom-scroll mt-4">
                          <div className="mb-6">
                              <h3 className="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Chats</h3>
                              {sessions.map(s => (
                                  <button key={s.id} onClick={() => {setActiveId(s.id); setCurrentView('chat'); setIsSidebarOpen(false);}} className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-0.5 truncate transition-colors ${activeId===s.id && currentView==='chat' ? 'bg-white shadow-sm font-medium text-slate-900' : 'text-slate-600 hover:bg-slate-200/50'}`}>{s.title}</button>
                              ))}
                          </div>
                          <div>
                              <h3 className="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Projects</h3>
                              {projects.map(p => (
                                  <button key={p.id} onClick={() => {setViewingProject(p); setCurrentView('project-view'); setIsSidebarOpen(false);}} className={`w-full text-left px-3 py-2 rounded-lg text-sm mb-0.5 truncate transition-colors ${viewingProject?.id===p.id && currentView==='project-view' ? 'bg-white shadow-sm font-medium text-slate-900' : 'text-slate-600 hover:bg-slate-200/50'}`}>
                                      <span className="flex items-center gap-2">
                                          {p.type === 'webapp' ? <CodeIcon className="w-3 h-3 text-blue-500"/> : <BookIcon className="w-3 h-3 text-amber-500"/>}
                                          {p.title}
                                      </span>
                                  </button>
                              ))}
                              {projects.length === 0 && <p className="px-3 text-xs text-slate-400 italic">No projects yet.</p>}
                          </div>
                      </div>
                      
                      <div className="p-4 border-t border-slate-200">
                          <button onClick={handleSignOut} className="flex items-center gap-2 text-xs font-semibold text-slate-500 hover:text-red-600 w-full p-2 hover:bg-slate-100 rounded-lg transition-colors"><LogOutIcon className="w-4 h-4"/> Sign Out</button>
                      </div>
                  </aside>

                  <main className="flex-1 flex flex-col h-full relative min-w-0 bg-white">
                      {currentView === 'project-view' && viewingProject && (
                           viewingProject.type === 'webapp' ? (
                               <div className="flex flex-col h-full">
                                    <div className="bg-white border-b border-slate-200 p-2 flex items-center justify-between">
                                        <div className="flex items-center gap-2 px-2">
                                            <span className="font-bold">{viewingProject.title}</span>
                                            <span className="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">App</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => handleShareProject(viewingProject)} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold flex items-center gap-1 transition-colors"><ShareIcon className="w-3 h-3"/> Share Link</button>
                                            <button onClick={() => setCurrentView('chat')} className="p-2 hover:bg-slate-100 rounded-full"><CloseIcon className="w-5 h-5"/></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-slate-100 overflow-hidden relative">
                                        <RunPreview code={viewingProject.code} language="html" onClose={()=>{}} onToast={setToast} isStandalone={true} />
                                    </div>
                               </div>
                           ) : (
                               <div className="h-full flex flex-col">
                                   <div className="bg-white border-b border-slate-200 p-2 flex items-center justify-between shrink-0 z-30">
                                       <div className="flex items-center gap-2 px-2">
                                            <span className="font-bold truncate max-w-[150px]">{viewingProject.title}</span>
                                            <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">Book</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => handleShareProject(viewingProject)} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded text-xs font-bold flex items-center gap-1 transition-colors"><ShareIcon className="w-3 h-3"/> Share Link</button>
                                            <button onClick={() => setCurrentView('chat')} className="p-2 hover:bg-slate-100 rounded-full"><CloseIcon className="w-5 h-5"/></button>
                                        </div>
                                   </div>
                                   <div className="flex-1 overflow-hidden">
                                       <EBookViewer book={viewingProject.content} onClose={null} isStandalone={false} />
                                   </div>
                               </div>
                           )
                      )}

                      {currentView === 'chat' && (
                          <>
                            <header className="h-14 flex items-center justify-between px-4 border-b border-slate-100 bg-white/80 backdrop-blur sticky top-0 z-20">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 -ml-2"><MenuIcon className="w-6 h-6 text-slate-700"/></button>
                                    <span className="font-bold lg:hidden">bapkam</span>
                                </div>
                            </header>
                            
                            <div className="flex-1 overflow-y-auto custom-scroll p-4 lg:p-6 pb-24" ref={chatRef}>
                                {!hasMessages ? (
                                    <div className="h-full flex flex-col items-center justify-center -mt-10 animate-fade-in-up">
                                         <BapkamLogo className="w-24 h-24 mb-6" />
                                         <h1 className="text-4xl font-black text-slate-900 tracking-tight mb-2">BAPKAM</h1>
                                         <p className="text-slate-500 font-medium tracking-wide">let's solve everything</p>
                                    </div>
                                ) : (
                                    activeSession.messages.map((m, i) => (
                                        <div key={i} className={`flex mb-4 ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`flex flex-col gap-2 max-w-[85%]`}>
                                                <div className={`rounded-2xl px-5 py-3 text-sm lg:text-base shadow-sm ${m.role === 'user' ? 'bg-slate-100 text-slate-900 rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>
                                                    <div className="whitespace-pre-wrap">{m.content}</div>
                                                </div>
                                                {m.project && (
                                                    <div onClick={() => {setViewingProject(m.project); setCurrentView('project-view');}} className="cursor-pointer bg-slate-50 border border-slate-200 p-4 rounded-xl hover:bg-slate-100 transition-colors flex items-center gap-4 group">
                                                        <div className={`w-12 h-12 rounded-lg flex items-center justify-center shadow-sm ${m.project.type==='webapp' ? 'bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600' : 'bg-gradient-to-br from-amber-100 to-orange-100 text-amber-600'}`}>
                                                            {m.project.type==='webapp' ? <CodeIcon className="w-6 h-6"/> : <BookIcon className="w-6 h-6"/>}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-bold text-slate-900 truncate text-lg">{m.project.title}</div>
                                                            <div className="text-xs text-slate-500 font-medium uppercase tracking-wider">{m.project.type==='webapp' ? 'Web Application' : 'E-Book'}</div>
                                                        </div>
                                                        <div className="bg-white p-2.5 rounded-full border border-slate-200 group-hover:border-slate-300 shadow-sm">
                                                            <ArrowRightIcon className="w-5 h-5 text-slate-400 group-hover:text-slate-900"/>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                                {isStreaming && (
                                     <div className="flex mb-4 justify-start">
                                        <div className="bg-white/80 backdrop-blur border border-slate-200/50 rounded-2xl rounded-tl-none px-5 py-4 shadow-sm flex items-center gap-3">
                                             {/* Water Wave Loader */}
                                             <div className="relative w-8 h-8 rounded-full overflow-hidden bg-blue-50 border border-blue-100 shadow-inner">
                                                <div className="absolute bottom-0 left-0 right-0 h-[150%] w-[200%] animate-wave-flow bg-gradient-to-t from-cyan-400 to-blue-500 opacity-60"></div>
                                                <div className="absolute bottom-0 left-0 right-0 h-[150%] w-[200%] animate-wave-flow-fast bg-gradient-to-t from-blue-500 to-indigo-500 opacity-60" style={{left: '-50%'}}></div>
                                             </div>
                                             <span className="text-sm text-slate-600 font-medium tracking-wide text-xs animate-pulse">{engineStatus || "Bapkam is flowing..."}</span>
                                        </div>
                                     </div>
                                )}
                            </div>

                            <div className="absolute bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur border-t border-slate-100 z-30">
                                <div className="max-w-4xl mx-auto flex items-end gap-2 bg-slate-50 border border-slate-200 rounded-3xl p-2 focus-within:ring-2 focus-within:ring-violet-200 transition-all shadow-sm">
                                    <textarea value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => {if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); handleSend();}}} placeholder={isProMode ? "Ask Bapkam Pro to create a website or write a novel..." : "Message Bapkam..."} className="flex-1 bg-transparent outline-none p-3 resize-none max-h-32 text-slate-800 placeholder-slate-400" rows={1}/>
                                    <button onClick={() => handleSend()} className={`p-3 rounded-full transition-all ${input.trim() ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-300'}`}><SendIcon className="w-5 h-5"/></button>
                                </div>
                            </div>
                          </>
                      )}
                  </main>
                  {toast && <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-lg z-50 animate-fade-in-up">{toast}</div>}
              </div>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>bapkam.ai</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Process Polyfill with API KEY -->
    <script>
      // INTEGRATED API KEY HERE
      window.process = { env: { API_KEY: 'AIzaSyD86LpzS-pnTr4enrR0DjGhFntcwOfiJcg' } };
    </script>

    <!-- 
      CRITICAL FIX: Load Google GenAI SDK via Module Script and expose to Window.
      Using esm.sh with specific version to ensure stability.
    -->
    <script type="module">
      import { GoogleGenAI } from "https://esm.sh/@google/genai@0.1.1";
      window.GoogleGenAI = GoogleGenAI;
      console.log("GenAI SDK Loaded");
    </script>

    <style>
        @keyframes fade-in-up {
            from { opacity: 0; transform: translate(-50%, 10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>
</head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      // --- IMPORTS & SETUP ---
      const { useState, useEffect, useRef, useCallback } = React;

      // --- ICONS ---
      const SendIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>
      );
      const UserIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>
      );
      const AIIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /><circle cx="12" cy="7" r="1" fill="currentColor" /></svg>
      );
      const LinkIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72" /></svg>
      );
      const ChatIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      );
      const PlusIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      );
      const CloseIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      );
      const ThreeDotsVerticalIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
      );
      const PaperclipIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
      );
      const MenuIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      );
      const ImageIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></svg>
      );
      const LogInIcon = ({ className }) => (
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" /><polyline points="10 17 15 12 10 7" /><line x1="15" y1="12" x2="3" y2="12" /></svg>
      );
      const NewChatIcon = PlusIcon;
      const GalleryIcon = ImageIcon;


      // --- SERVICES ---
      const OPENROUTER_API_KEY = "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";
      const API_KEY = (typeof process !== 'undefined' ? process.env?.API_KEY : '') || 'AIzaSyD86LpzS-pnTr4enrR0DjGhFntcwOfiJcg';
      
      // Helper to get AI instance safely
      function getAI() {
        if (typeof window.GoogleGenAI === 'undefined') {
          return null;
        }
        try {
           return new window.GoogleGenAI({ apiKey: API_KEY });
        } catch (e) {
           return null;
        }
      }

      // Retry function to wait for SDK to load
      async function ensureAI() {
          const ai = getAI();
          if (ai) return ai;

          // Wait up to 10 seconds for the SDK to load
          for (let i = 0; i < 50; i++) {
              await new Promise(resolve => setTimeout(resolve, 200));
              const retryAi = getAI();
              if (retryAi) return retryAi;
          }
          throw new Error("Connection slow: AI SDK failed to load. Please refresh the page.");
      }

      async function getOpenRouterResponse(prompt, model, history) {
          try {
              const messages = history
                  .filter(msg => msg.content && !msg.content.startsWith('data:image'))
                  .map(msg => ({
                      role: msg.role === 'user' ? 'user' : 'assistant',
                      content: msg.content,
                  }));
              
              messages.push({ role: 'user', content: prompt });

              const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                      'HTTP-Referer': 'https://bapkam.ai', 
                      'X-Title': 'bapkam.ai',
                  },
                  body: JSON.stringify({ model: model, messages: messages }),
              });

              if (!response.ok) throw new Error(`API call failed: ${response.status}`);
              const data = await response.json();
              return data.choices[0]?.message?.content || "";
          } catch (error) {
              console.error(`OpenRouter Error (${model}):`, error);
              throw error;
          }
      }

      async function classifyPrompt(prompt) {
        try {
          const ai = await ensureAI();
          const systemInstruction = `You are a prompt routing expert. Respond with ONLY 'bapkam' or 'deepsingh'.`;
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: { systemInstruction, temperature: 0, topK: 1 },
          });
          return response.text.trim().toLowerCase() === 'deepsingh' ? 'deepsingh' : 'bapkam';
        } catch (error) { return 'bapkam'; }
      }

      function getSystemInstruction(engine) {
        const timeOfDay = new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 17 ? 'afternoon' : 'evening';
        if (engine === 'deepsingh') return 'You are Deep Singh, an expert AI in technical topics and philosophy. Be profound and formal.';
        return `You are Bapkam, a friendly, witty AI friend from India. It is ${timeOfDay}. Be conversational, human-like, and engaging.`;
      }

      async function generateChatResponse(prompt, history) {
          if (!API_KEY) throw new Error("API Key is missing. Please check configuration.");
          
          // Wait for SDK
          const ai = await ensureAI();
          
          const engine = await classifyPrompt(prompt);
          const instruction = getSystemInstruction(engine);
          const historyParts = history
            .filter(msg => msg.content && !msg.content.startsWith('data:image'))
            .map(msg => ({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] }));

          try {
              const geminiChat = ai.chats.create({ model: 'gemini-2.5-flash', config: { systemInstruction: instruction }, history: historyParts });
              
              const promises = [
                  geminiChat.sendMessage({ message: prompt }).then(res => ({ source: 'Gemini', text: res.text })),
                  getOpenRouterResponse(prompt, 'deepseek/deepseek-chat', history).then(text => ({ source: 'DeepSeek', text })),
                  getOpenRouterResponse(prompt, 'openai/gpt-4o-mini', history).then(text => ({ source: 'GPT', text }))
              ];

              const results = await Promise.allSettled(promises);
              const successful = results.filter(r => r.status === 'fulfilled' && r.value.text).map(r => r.value);
              
              if (successful.length === 0) throw new Error("All models failed.");

              const synthesisPrompt = `Synthesize these answers into one friendly Bapkam response to: "${prompt}".\n\n${successful.map(r => `--- ${r.source} ---\n${r.text}`).join('\n\n')}`;
              
              const synthesis = await ai.models.generateContent({
                  model: 'gemini-2.5-flash',
                  contents: synthesisPrompt,
                  config: { systemInstruction: instruction }
              });

              return { text: synthesis.text, modelSources: successful.map(r => r.source).sort() };
          } catch (e) {
              console.error("Orchestration failed, falling back", e);
               // Fallback single call
               const chat = ai.chats.create({ model: 'gemini-2.5-flash', config: { systemInstruction: instruction }, history: historyParts });
               const res = await chat.sendMessage({ message: prompt });
               return { text: res.text, modelSources: ['Gemini'] };
          }
      }

      async function generateImage(prompt) {
          const ai = await ensureAI();
          const response = await ai.models.generateContent({
              model: 'gemini-2.5-flash-image',
              contents: { parts: [{ text: prompt }] },
              config: { responseModalities: ['IMAGE'] },
          });
          const part = response.candidates[0].content.parts.find(p => p.inlineData);
          if (part) return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
          throw new Error('No image generated');
      }

      // --- COMPONENTS ---

      const LoadingIndicator = () => (
        <div className="flex items-start gap-3">
           <div className="w-8 h-8 flex-shrink-0 bg-slate-200 rounded-full flex items-center justify-center">
              <AIIcon className="w-5 h-5 text-slate-600" />
            </div>
          <div className="px-4 py-3 rounded-2xl bg-white border border-slate-200 rounded-bl-none">
            <div className="flex items-center gap-2">
                <span className="text-sm text-slate-500">Bapkam is working...</span>
                <div className="flex items-center justify-center space-x-1">
                <div className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                <div className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                <div className="w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce"></div>
                </div>
            </div>
          </div>
        </div>
      );

      const SourceLinks = ({ sources }) => {
        if (!sources || sources.length === 0) return null;
        return (
          <div className="mt-2 pl-1 max-w-sm md:max-w-md lg:max-w-lg">
            <h4 className="text-xs font-semibold text-slate-500 mb-1">Sources:</h4>
            <div className="flex flex-wrap gap-2">
              {sources.map((source, index) => (
                <a key={index} href={source.uri} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded-md transition-colors">
                  <LinkIcon className="w-3 h-3 flex-shrink-0" />
                  <span className="truncate">{source.title || new URL(source.uri).hostname}</span>
                </a>
              ))}
            </div>
          </div>
        );
      };

      const Message = ({ message }) => {
        const isUser = message.role === 'user';
        const isImage = !isUser && message.content.startsWith('data:image');
        
        const linkify = (text) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.split(urlRegex).map((part, i) => part.match(urlRegex) ? <a key={i} href={part} target="_blank" className="text-red-500 hover:underline">{part}</a> : part);
        };

        return (
          <div className={`flex items-start gap-3 ${isUser ? 'justify-end' : ''}`}>
            {!isUser && <div className="w-8 h-8 flex-shrink-0 bg-slate-200 rounded-full flex items-center justify-center"><AIIcon className="w-5 h-5 text-slate-600" /></div>}
            <div className={`flex flex-col gap-2 ${isUser ? 'items-end' : 'items-start'}`}>
              {message.attachment && isUser && (
                  <div className="max-w-xs md:max-w-sm overflow-hidden rounded-2xl rounded-br-none">
                    <img src={message.attachment.url} alt="User upload" className="w-full h-auto" />
                  </div>
              )}
              {isImage ? (
                <div className="rounded-2xl max-w-sm md:max-w-md lg:max-w-lg overflow-hidden bg-white border border-slate-200"><img src={message.content} className="w-full h-auto"/></div>
              ) : (
                 (message.content.trim() || !isUser) && (
                    <div className={`px-4 py-3 rounded-2xl max-w-sm md:max-w-md lg:max-w-lg break-words ${isUser ? 'bg-red-600 text-white rounded-br-none' : 'bg-white text-slate-800 rounded-bl-none border border-slate-200'}`}>
                        <p className="whitespace-pre-wrap">{linkify(message.content)}</p>
                        {!isUser && message.modelSources && <p className="mt-3 pt-2 border-t border-slate-200/60 text-xs text-slate-500">Researched using: {message.modelSources.join(', ')}</p>}
                    </div>
                 )
              )}
              {!isUser && <SourceLinks sources={message.sources || []} />}
            </div>
            {isUser && <div className="w-8 h-8 flex-shrink-0 bg-red-500 rounded-full flex items-center justify-center"><UserIcon className="w-5 h-5 text-white" /></div>}
          </div>
        );
      };

      const ChatInput = ({ onSendMessage, isLoading, filePreview, onFileSelect, onFileRemove }) => {
        const [input, setInput] = useState('');
        const [isMenuOpen, setIsMenuOpen] = useState(false);
        const fileInputRef = useRef(null);
        const menuRef = useRef(null);

        useEffect(() => {
          const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
              setIsMenuOpen(false);
            }
          };
          document.addEventListener('mousedown', handleClickOutside);
          return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);
        
        const handleSubmit = (e) => {
            e.preventDefault();
            if ((input.trim() || filePreview) && !isLoading) {
                onSendMessage(input);
                setInput('');
            }
        };

        return (
          <div className="relative">
            {filePreview && (
                <div className="absolute bottom-full left-0 mb-3 p-2 bg-white border border-slate-200 rounded-lg shadow-lg">
                    <div className="relative"><img src={filePreview.url} className="max-h-32 rounded-md" /><button onClick={onFileRemove} className="absolute -top-2 -right-2 bg-slate-200 rounded-full p-0.5"><CloseIcon className="w-4 h-4" /></button></div>
                </div>
            )}
            <form onSubmit={handleSubmit} className="flex items-center space-x-3 bg-white border border-slate-300 rounded-full p-2 focus-within:ring-2 focus-within:ring-red-500 transition-shadow">
                 <div className="relative" ref={menuRef}>
                    <button type="button" onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-slate-500 rounded-full p-2 hover:bg-slate-100"><ThreeDotsVerticalIcon className="w-5 h-5" /></button>
                    {isMenuOpen && (
                        <div className="absolute bottom-full left-0 mb-2 w-48 bg-white border border-slate-200 rounded-lg shadow-xl z-10 py-1">
                            <button type="button" onClick={() => { fileInputRef.current.click(); setIsMenuOpen(false); }} className="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><PaperclipIcon className="w-4 h-4" /><span>Upload File</span></button>
                            <button type="button" onClick={() => { setInput('/imagine '); setIsMenuOpen(false); }} className="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><ImageIcon className="w-4 h-4" /><span>Generate Image</span></button>
                        </div>
                    )}
                </div>
                <input type="file" ref={fileInputRef} onChange={(e) => onFileSelect(e.target.files[0])} accept="image/*" hidden />
                <input value={input} onChange={(e) => setInput(e.target.value)} placeholder={input.startsWith('/imagine') ? "Describe image..." : "Message Bapkam..."} className="flex-1 bg-transparent pr-4 py-2 text-slate-900 placeholder-slate-400 focus:outline-none" disabled={isLoading} />
                <button type="submit" disabled={isLoading || (!input.trim() && !filePreview)} className="bg-red-600 text-white rounded-full p-3 hover:bg-red-500 disabled:bg-slate-300"><SendIcon className="w-5 h-5" /></button>
            </form>
          </div>
        );
      };

      const ChatWindow = ({ session, onSendMessage, isLoading, isLoggedIn, onLogin }) => {
        const [attachmentFile, setAttachmentFile] = useState(null);
        const [attachmentPreview, setAttachmentPreview] = useState(null);
        const messagesEndRef = useRef(null);
        
        useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [session?.messages, isLoading]);
        
        const handleFileSelect = (file) => {
            setAttachmentFile(file);
            setAttachmentPreview({ url: URL.createObjectURL(file), type: 'image' });
        };

        const handleSendMessageWrapper = (userInput) => {
            onSendMessage(userInput, attachmentFile);
            setAttachmentFile(null);
            setAttachmentPreview(null);
        };

        if (!isLoggedIn && !session) {
            return (
                <div className="flex-1 flex flex-col items-center justify-center text-center -mt-16 px-4">
                    <div className="w-20 h-20 mb-6 bg-gradient-to-br from-red-500 to-orange-400 rounded-full flex items-center justify-center shadow-lg"><AIIcon className="w-10 h-10 text-white" /></div>
                    <h1 className="text-4xl md:text-5xl font-bold text-slate-800"><span className="text-red-600">bapkam</span>.ai</h1>
                    <p className="mt-4 text-lg text-slate-500">Login to enjoy our chat.</p>
                    <button onClick={onLogin} className="mt-8 flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-full font-semibold hover:scale-105 transition-transform shadow-lg"><LogInIcon className="w-5 h-5" /><span>Login to Get Started</span></button>
                </div>
            );
        }

        return (
          <div className="h-full flex flex-col max-w-4xl mx-auto">
            <div className="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col">
               {session?.messages.map((msg, i) => <Message key={i} message={msg} />)}
               {isLoading && <LoadingIndicator />}
               <div ref={messagesEndRef} />
            </div>
            <div className="p-4 md:p-6 bg-slate-50 border-t border-slate-200">
                <ChatInput onSendMessage={handleSendMessageWrapper} isLoading={isLoading} filePreview={attachmentPreview} onFileSelect={handleFileSelect} onFileRemove={() => { setAttachmentFile(null); setAttachmentPreview(null); }} />
            </div>
          </div>
        );
      };

      const Sidebar = ({ sessions, activeSessionId, onNewChat, onSelectSession, onShowGallery, isSidebarOpen, currentView, isLoggedIn }) => (
        <aside className={`absolute md:relative flex-shrink-0 w-64 bg-slate-800 text-slate-200 flex flex-col transition-transform duration-300 ease-in-out z-20 h-full ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0`}>
            <div className="p-4 border-b border-slate-700">
                <button onClick={onNewChat} className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-md font-semibold"><NewChatIcon className="w-5 h-5" /><span>New Chat</span></button>
            </div>
            <nav className="flex-1 overflow-y-auto p-4 space-y-4">
                <div><h3 className="px-2 mb-2 text-xs font-semibold text-slate-400 uppercase">Conversations</h3>
                <ul className="space-y-1">{isLoggedIn && sessions.map(s => (
                    <li key={s.id}><a href="#" onClick={(e) => {e.preventDefault(); onSelectSession(s.id);}} className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm ${activeSessionId === s.id && currentView === 'chat' ? 'bg-red-600 text-white' : 'hover:bg-slate-700'}`}><ChatIcon className="w-4 h-4" /><span className="truncate">{s.title}</span></a></li>
                ))}</ul></div>
                <div><h3 className="px-2 mb-2 text-xs font-semibold text-slate-400 uppercase">Library</h3>
                <ul><li><a href="#" onClick={(e) => {e.preventDefault(); onShowGallery();}} className={`flex items-center gap-3 px-3 py-2 rounded-md text-sm ${currentView === 'gallery' ? 'bg-red-600 text-white' : 'hover:bg-slate-700'}`}><GalleryIcon className="w-4 h-4" /><span>Image Library</span></a></li></ul></div>
            </nav>
        </aside>
      );

      const Gallery = ({ images, isLoggedIn, onLogin }) => {
         if (!isLoggedIn) return (
            <div className="h-full flex flex-col items-center justify-center text-center p-8">
                <h1 className="text-3xl font-bold text-slate-800">Your Image Library</h1>
                <button onClick={onLogin} className="mt-8 flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-full font-semibold shadow-lg"><LogInIcon className="w-5 h-5" /><span>Login to View</span></button>
            </div>
         );
         return (
             <div className="h-full overflow-y-auto bg-slate-100 p-4">
                <h1 className="text-2xl font-bold text-slate-800 mb-6">Image Library</h1>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {images.map((src, i) => <div key={i} className="aspect-square rounded-lg overflow-hidden shadow-md"><img src={src} className="w-full h-full object-cover hover:scale-105 transition-transform" /></div>)}
                </div>
             </div>
         )
      }

      const Header = ({ toggleSidebar, isLoggedIn, onLogin, onLogout }) => (
         <header className="bg-white/80 backdrop-blur-sm shadow-sm p-4 border-b border-slate-200 sticky top-0 z-20 flex justify-between items-center">
             <div className="flex items-center gap-4">
                 <button onClick={toggleSidebar} className="md:hidden p-2 -ml-2"><MenuIcon className="w-6 h-6 text-slate-700"/></button>
                 <h1 className="text-xl font-bold text-slate-800 tracking-wide"><span className="text-red-600">bapkam</span>.ai</h1>
             </div>
             <div>
                 {isLoggedIn ? (
                     <div className="flex items-center gap-3">
                         <img src="https://ui-avatars.com/api/?name=User&background=ef4444&color=fff" className="w-10 h-10 rounded-full border-2 border-red-500" />
                         <button onClick={onLogout} className="text-sm font-medium text-slate-600 hover:text-red-600">Sign Out</button>
                     </div>
                 ) : (
                     <button onClick={onLogin} className="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center hover:bg-slate-300"><LogInIcon className="w-5 h-5 text-slate-600" /></button>
                 )}
             </div>
         </header>
      );

      // --- APP ---
      const App = () => {
          const [sessions, setSessions] = useState([]);
          const [activeSessionId, setActiveSessionId] = useState(null);
          const [generatedImages, setGeneratedImages] = useState([]);
          const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 768);
          const [currentView, setCurrentView] = useState('chat');
          const [isLoading, setIsLoading] = useState(false);
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [toast, setToast] = useState(null);
          const [isSdkReady, setIsSdkReady] = useState(false);

          useEffect(() => {
              const handleResize = () => setIsSidebarOpen(window.innerWidth > 768);
              window.addEventListener('resize', handleResize);
              
              // SDK Check Poll
              const checkSdk = () => {
                 if (window.GoogleGenAI) {
                     setIsSdkReady(true);
                 } else {
                     setTimeout(checkSdk, 200);
                 }
              };
              checkSdk();

              return () => window.removeEventListener('resize', handleResize);
          }, []);

          useEffect(() => {
              if(!isSdkReady) {
                  showToast("Initializing AI capabilities, please wait...");
              } else {
                  setToast(null);
              }
          }, [isSdkReady]);

          const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 4000); };
          const handleLogin = () => { setIsLoggedIn(true); showToast("Successfully logged in!"); };
          const handleNewChat = () => { 
              if(!isLoggedIn) return handleLogin();
              setActiveSessionId(null); setCurrentView('chat'); if(window.innerWidth<=768) setIsSidebarOpen(false); 
          };
          
          const handleSendMessage = async (text, file) => {
             if (isLoading) return;
             if (!isSdkReady) { showToast("AI is still loading. Please wait a moment..."); return; }

             let currentId = activeSessionId;
             if (!currentId) {
                 currentId = Date.now().toString();
                 setActiveSessionId(currentId);
                 setSessions(prev => [{ id: currentId, title: text.substring(0, 30) || "New Chat", messages: [] }, ...prev]);
             }
             
             const userMsg = { role: 'user', content: text, attachment: file ? { url: URL.createObjectURL(file) } : undefined };
             setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, userMsg] } : s));
             
             setIsLoading(true);
             try {
                 if (text.startsWith('/imagine ')) {
                     const url = await generateImage(text.substring(9));
                     setGeneratedImages(prev => [url, ...prev]);
                     setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, { role: 'model', content: url }] } : s));
                 } else {
                     const result = await generateChatResponse(text, sessions.find(s => s.id === currentId)?.messages || []);
                     setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, { role: 'model', content: result.text, modelSources: result.modelSources }] } : s));
                 }
             } catch (e) {
                 setSessions(prev => prev.map(s => s.id === currentId ? { ...s, messages: [...s.messages, { role: 'model', content: `Error: ${e.message}` }] } : s));
             } finally { setIsLoading(false); }
          };

          const activeSession = sessions.find(s => s.id === activeSessionId) || null;

          return (
              <div className="flex flex-col h-[100dvh] text-slate-900 font-sans">
                  <Header toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} isLoggedIn={isLoggedIn} onLogin={handleLogin} onLogout={() => { setIsLoggedIn(false); showToast("Logged out"); setSessions([]); }} />
                  <div className="flex-1 flex overflow-hidden">
                      <Sidebar sessions={sessions} activeSessionId={activeSessionId} onNewChat={handleNewChat} onSelectSession={(id) => { setActiveSessionId(id); setCurrentView('chat'); if(window.innerWidth<=768) setIsSidebarOpen(false); }} onShowGallery={() => { setCurrentView('gallery'); if(window.innerWidth<=768) setIsSidebarOpen(false); }} isSidebarOpen={isSidebarOpen} currentView={currentView} isLoggedIn={isLoggedIn} />
                      <main className="flex-1 overflow-hidden relative">
                          {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="absolute inset-0 bg-black/30 z-10 md:hidden"></div>}
                          {currentView === 'chat' ? <ChatWindow session={activeSession} onSendMessage={handleSendMessage} isLoading={isLoading} isLoggedIn={isLoggedIn} onLogin={handleLogin} /> : <Gallery images={generatedImages} isLoggedIn={isLoggedIn} onLogin={handleLogin} />}
                      </main>
                  </div>
                  {toast && <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-2 rounded-full shadow-lg z-50 animate-fade-in-up text-sm whitespace-nowrap">{toast}</div>}
              </div>
          );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>bapkam.ai</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><g transform=%22translate(50,50)%22><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(0) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(30) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(60) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(90) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(120) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#111827%22 transform=%22rotate(150) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#1f2937%22 transform=%22rotate(180) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#374151%22 transform=%22rotate(210) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#4b5563%22 transform=%22rotate(240) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#6b7280%22 transform=%22rotate(270) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#9ca3af%22 transform=%22rotate(300) translate(0, -10)%22 opacity=%220.95%22 /><path d=%22M0 -30 L5 -45 L10 -35 L5 -25 Z%22 fill=%22#d1d5db%22 transform=%22rotate(330) translate(0, -10)%22 opacity=%220.95%22 /></g></svg>" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { 
                sans: ['Inter', 'sans-serif'],
                mono: ['JetBrains Mono', 'monospace']
            },
            animation: { 
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                'fade-in': 'fadeIn 0.3s ease-out forwards',
                'spin-slow': 'spin 3s linear infinite',
                'spin-slower': 'spin 12s linear infinite', 
                'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
                'shimmer': 'shimmer 2s linear infinite',
            },
            keyframes: {
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                shimmer: {
                    '0%': { backgroundPosition: '200% 0' },
                    '100%': { backgroundPosition: '-200% 0' }
                }
            },
            colors: {
                pro: {
                    50: '#f0fdf4',
                    100: '#dcfce7',
                    500: '#22c55e',
                    600: '#16a34a',
                    900: '#14532d',
                    glow: '#4ade80'
                }
            },
            dropShadow: {
                'cyan': '0 0 8px rgba(34, 211, 238, 0.5)',
            }
          }
        }
      }
    </script>
    
    <!-- Environment & Console Polyfills (CRITICAL: Must run before other scripts) -->
    <script>
        // Polyfill process.env for browser environments to prevent crashes
        window.process = window.process || {};
        window.process.env = window.process.env || {};

        const originalWarn = console.warn;
        const originalError = console.error;

        console.warn = function(...args) {
            const str = args.map(a => String(a)).join(' ');
            if (
                str.includes('in-browser Babel transformer') || 
                str.includes('Imagen 3 failed') || 
                str.includes('Pro model failed')
            ) return;
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
             const str = args.map(a => String(a)).join(' ');
             if (
                 (str.includes('404') || str.includes('403')) && 
                 (str.includes('generateImages') || str.includes('generateContent'))
             ) return;
             originalError.apply(console, args);
        };
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; background-color: #ffffff; overscroll-behavior: none; text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
        #root { position: fixed; inset: 0; height: 100dvh; width: 100vw; display: flex; flex-direction: column; z-index: 1; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        * { -webkit-tap-highlight-color: transparent; }
        
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }

        /* Syntax Highlighting */
        .token-keyword { color: #ff7b72; font-weight: 600; }
        .token-string { color: #a5d6ff; }
        .token-comment { color: #8b949e; font-style: italic; }
        .token-function { color: #d2a8ff; }
        .token-number { color: #79c0ff; }
        .token-class { color: #f0883e; }
        
        /* Markdown Styles for Chat */
        .prose-content ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose-content ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose-content strong { font-weight: 700; color: #1e293b; }
        .prose-content em { font-style: italic; }
        .prose-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #0f172a; }
        .prose-content h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #0f172a; }
        .prose-content p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose-content p:last-child { margin-bottom: 0; }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://esm.sh/react@18.3.1",
    "react/": "https://esm.sh/react@18.3.1/",
    "react-dom": "https://esm.sh/react-dom@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";

      // --- ERROR BOUNDARY ---
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false, error: null };
        }

        static getDerivedStateFromError(error) {
          return { hasError: true, error };
        }

        componentDidCatch(error, errorInfo) {
          console.error("Uncaught Error:", error, errorInfo);
        }

        render() {
          if (this.state.hasError) {
            return (
              <div className="flex flex-col items-center justify-center h-screen bg-slate-50 p-4 text-center">
                 <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4 text-3xl">!</div>
                 <h1 className="text-xl font-bold text-slate-900 mb-2">Something went wrong</h1>
                 <button onClick={() => window.location.reload()} className="mt-6 px-4 py-2 bg-slate-900 text-white rounded-lg">Refresh App</button>
              </div>
            );
          }
          return this.props.children;
        }
      }

      // --- ICONS ---
      const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>;
      const SendIcon = (p) => <Icon d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7" {...p} />;
      const MenuIcon = (p) => <Icon d="M4 6h16M4 12h16M4 18h16" {...p} />;
      const PlusIcon = (p) => <Icon d="M12 5v14M5 12h14" {...p} />;
      const CloseIcon = (p) => <Icon d="M18 6 6 18M6 6l12 12" {...p} />;
      const SearchIcon = (p) => <Icon d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 16zM21 21l-4.35-4.35" {...p} />;
      const CodeIcon = (p) => <Icon d="M16 18 22 12 16 6M8 6 2 12 8 18" {...p} />;
      const SparklesIcon = (p) => <Icon d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" {...p} />;
      const CheckIcon = (p) => <Icon d="M20 6 9 17l-5-5" {...p} />;
      const CopyIcon = (p) => <Icon d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 18v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2" {...p} />;
      const ShareIcon = (p) => <Icon d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8m-4-6-4-4-4 4m4-4v13" {...p} />;
      const ZapIcon = (p) => <Icon d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" {...p} />;
      const MagicWandIcon = (p) => <Icon d="M10.5 10.5 3 3m18 18-7.5-7.5M10.5 10.5l4-4m-4 4 5 5m.5-9.5L21 3l-4.5 4.5m-11 11 6.5-6.5" {...p} />;
      const LogOutIcon = (p) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-12-5 7M21 12H9" {...p} />;
      const TrashIcon = (p) => <Icon d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" {...p} />;
      const PaletteIcon = (p) => <Icon d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" {...p} />;
      const TemplateIcon = (p) => <Icon d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2v-4M9 21H5a2 2 0 0 1-2-2v-4" {...p} />;
      const TextIcon = (p) => <Icon d="M4 7V4h16v3M9 20h6M12 4v16" {...p} />;
      const PaperclipIcon = (p) => <Icon d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" {...p} />;
      
      // --- COMPONENTS ---

      const BapkamLogo = ({ className = "w-10 h-10", isPro = false }) => (
        <div className={`${className} relative flex items-center justify-center`}>
            {isPro && (
                <>
                    <div className="absolute inset-0 bg-cyan-500 rounded-full blur-xl opacity-40 animate-pulse" style={{ animationDuration: '2s' }}></div>
                    <div className="absolute -inset-2 bg-blue-500 rounded-full blur-2xl opacity-20 animate-ping-slow"></div>
                </>
            )}
            <svg viewBox="0 0 100 100" className={`w-full h-full relative z-10 transition-all duration-700 ease-in-out ${isPro ? 'animate-spin-slower drop-shadow-cyan' : ''}`} xmlns="http://www.w3.org/2000/svg">
                <g transform="translate(50,50)">
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#22d3ee" : "#111827"} transform="rotate(0) translate(0, -10)" opacity="0.95" />
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#06b6d4" : "#1f2937"} transform="rotate(60) translate(0, -10)" opacity="0.95" />
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#3b82f6" : "#374151"} transform="rotate(120) translate(0, -10)" opacity="0.95" />
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#60a5fa" : "#4b5563"} transform="rotate(180) translate(0, -10)" opacity="0.95" />
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#93c5fd" : "#6b7280"} transform="rotate(240) translate(0, -10)" opacity="0.95" />
                    <path d="M0 -30 L5 -45 L10 -35 L5 -25 Z" fill={isPro ? "#e0f2fe" : "#9ca3af"} transform="rotate(300) translate(0, -10)" opacity="0.95" />
                </g>
            </svg>
        </div>
      );

      const RainbowCyclone = ({ className = "w-6 h-6" }) => (
          <div className={`${className} rounded-full animate-spin-slow`} 
               style={{ 
                   background: 'conic-gradient(from 0deg, #ef4444, #f97316, #eab308, #22c55e, #06b6d4, #3b82f6, #a855f7, #ef4444)',
                   padding: '3px',
                   mask: 'radial-gradient(farthest-side, transparent calc(100% - 3px), #fff calc(100% - 3px + 1px))',
                   WebkitMask: 'radial-gradient(farthest-side, transparent calc(100% - 3px), #fff calc(100% - 3px + 1px))'
               }}>
          </div>
      );

      const CodeBlock = ({ language, code }) => {
          const [copied, setCopied] = useState(false);
          const handleCopy = () => {
              navigator.clipboard.writeText(code);
              setCopied(true);
              setTimeout(() => setCopied(false), 2000);
          };
          
          const highlighted = code
              .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
              .replace(/(['"`])(.*?)\1/g, '<span class="token-string">$1$2$1</span>')
              .replace(/\b(def|class|import|from|return|if|else|elif|for|while|try|except|async|await|const|let|var|function|print|console|new|this|window|document|export|default)\b/g, '<span class="token-keyword">$1</span>')
              .replace(/\b(\d+)\b/g, '<span class="token-number">$1</span>')
              .replace(/\b([A-Z][a-zA-Z0-9_]*)\b/g, '<span class="token-class">$1</span>')
              .replace(/(#.*|\/\/.*)$/gm, '<span class="token-comment">$1</span>');

          return (
              <div className="my-5 rounded-xl overflow-hidden border border-slate-200/80 shadow-xl bg-[#1e1e2e] text-slate-300 w-full group ring-1 ring-black/5 relative max-w-full">
                  <div className="flex items-center justify-between px-4 py-2.5 bg-[#181825] border-b border-white/10">
                      <div className="flex items-center gap-3">
                          <div className="flex gap-1.5 opacity-75">
                              <div className="w-2.5 h-2.5 rounded-full bg-[#ff5f56]"></div>
                              <div className="w-2.5 h-2.5 rounded-full bg-[#ffbd2e]"></div>
                              <div className="w-2.5 h-2.5 rounded-full bg-[#27c93f]"></div>
                          </div>
                          <span className="text-xs font-mono font-bold text-slate-400 uppercase tracking-wider ml-2">
                             {language || 'CODE'}
                          </span>
                      </div>
                      <button onClick={handleCopy} className="flex items-center gap-1.5 text-xs font-medium text-slate-400 hover:text-white transition-colors px-2 py-1 rounded hover:bg-white/10">
                          {copied ? <CheckIcon className="w-3.5 h-3.5 text-green-400" /> : <CopyIcon className="w-3.5 h-3.5" />}
                          {copied ? 'Copied' : 'Copy'}
                      </button>
                  </div>
                  <div className="relative overflow-x-auto custom-scroll bg-[#1e1e2e]">
                      <div className="flex min-w-full">
                          <div className="flex flex-col items-end px-3 py-4 text-right select-none text-[#6c7086] text-xs font-mono leading-6 border-r border-white/5 bg-[#1e1e2e] min-w-[40px]">
                               {code.trim().split('\n').map((_, i) => <span key={i}>{i + 1}</span>)}
                          </div>
                          <pre className="flex-1 px-4 py-4 text-[13px] font-mono leading-6 tab-4 outline-none text-[#cdd6f4]">
                              <code dangerouslySetInnerHTML={{ __html: highlighted }} />
                          </pre>
                      </div>
                  </div>
              </div>
          );
      };

      const MarkdownText = ({ text }) => {
          const formatText = (input) => {
              if (!input) return null;
              
              const paragraphs = input.split(/\n\n+/);
              
              return paragraphs.map((paragraph, i) => {
                  if (paragraph.startsWith('### ')) {
                      return <h3 key={i} className="text-lg font-bold mt-4 mb-2 text-slate-900">{paragraph.replace('### ', '')}</h3>;
                  }
                  if (paragraph.startsWith('## ')) {
                      return <h2 key={i} className="text-xl font-bold mt-6 mb-3 text-slate-900">{paragraph.replace('## ', '')}</h2>;
                  }
                  if (paragraph.match(/^[-â€¢] /m)) {
                      const items = paragraph.split(/\n/).filter(line => line.trim().startsWith('-') || line.trim().startsWith('â€¢'));
                      if (items.length > 0) {
                          return (
                              <ul key={i} className="list-disc pl-5 my-2 space-y-1 text-slate-800">
                                  {items.map((item, j) => {
                                      const content = item.replace(/^[-â€¢] /, '').trim();
                                      return (
                                          <li key={j} dangerouslySetInnerHTML={{
                                              __html: content
                                                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                  .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                          }} />
                                      );
                                  })}
                              </ul>
                          );
                      }
                  }

                  const htmlContent = paragraph
                      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                      .replace(/\*(.*?)\*/g, '<em>$1</em>')
                      .replace(/\n(?![-\d])/g, '<br/>');

                  return <p key={i} className="mb-3 last:mb-0 leading-relaxed text-[16px] text-slate-800" dangerouslySetInnerHTML={{ __html: htmlContent }} />;
              });
          };

          return <div className="prose-content">{formatText(text)}</div>;
      };

      const ChatMessage = ({ msg, isPro, isLatest, isLoading, botName }) => {
          const [copied, setCopied] = useState(false);
          const isUser = msg.role === 'user';

          const handleCopy = () => {
            navigator.clipboard.writeText(msg.content);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          };

          const handleShare = async () => {
            if (navigator.share) {
                try { await navigator.share({ title: 'Response', text: msg.content }); } catch (err) {}
            } else {
                navigator.clipboard.writeText(msg.content);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            }
          };

          const renderContent = () => {
            const hasImages = msg.images && msg.images.length > 0;
            const rawContent = msg.content || '';
            
            if (!isUser && !rawContent.trim() && isLoading && isLatest) {
                return (
                    <div className="flex items-center gap-3 text-slate-500 text-sm py-2">
                         <RainbowCyclone className="w-5 h-5" />
                         <span className="font-medium bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600 animate-pulse">
                            {msg.statusMessage || "Thinking..."}
                         </span>
                    </div>
                );
            }

            const parts = rawContent.split(/```(\w+)?\n([\s\S]*?)```/g);
            
            return (
                <div className="flex flex-col gap-2 w-full overflow-hidden">
                    {hasImages && (
                        <div className="flex flex-wrap gap-2 mb-2 justify-end">
                            {msg.images.map((img, i) => (
                                <div key={i} className="relative group">
                                    <img src={img} className="w-full h-auto object-cover rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:opacity-90" onClick={() => window.open(img, '_blank')} />
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {parts.map((part, index) => {
                        if (index % 3 === 0 && part.trim()) {
                            return <MarkdownText key={index} text={part} />;
                        }
                        if (index % 3 === 2) return <CodeBlock key={index} language={parts[index - 1]} code={part} />;
                    })}
                </div>
            );
          };

          return (
              <div className={`flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in group`}>
                  <div className={`flex w-full ${isUser ? 'flex-row-reverse max-w-2xl' : 'flex-row max-w-4xl'} gap-3 sm:gap-4`}>
                      {!isUser && (
                          <div className={`w-8 h-8 rounded-full bg-white border border-slate-100 shadow-sm flex items-center justify-center flex-shrink-0 mt-1 transition-all duration-500 overflow-hidden hidden sm:flex`}>
                             <BapkamLogo className="w-5 h-5" />
                          </div>
                      )}
                      <div className={`flex-1 min-w-0 ${isUser ? 'bg-slate-100 text-slate-900 px-4 py-3 rounded-2xl rounded-tr-sm' : 'pl-0 sm:pl-0'}`}>
                        {renderContent()}
                        {!isUser && msg.content.trim() && (
                            <div className="flex items-center gap-4 mt-2 pt-1">
                                <button onClick={handleCopy} className="opacity-0 group-hover:opacity-100 flex items-center gap-1.5 text-xs font-medium text-slate-400 hover:text-indigo-600 transition-all">
                                    {copied ? <CheckIcon className="w-3.5 h-3.5 text-green-500" /> : <CopyIcon className="w-3.5 h-3.5" />} 
                                    {copied ? 'Copied' : 'Copy'}
                                </button>
                                <button onClick={handleShare} className="opacity-0 group-hover:opacity-100 flex items-center gap-1.5 text-xs font-medium text-slate-400 hover:text-indigo-600 transition-all">
                                    <ShareIcon className="w-3.5 h-3.5" /> Share
                                </button>
                                {isPro && (
                                    <span className="text-[10px] text-indigo-400 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-wide font-bold opacity-0 group-hover:opacity-100 transition-opacity">
                                        Pro
                                    </span>
                                )}
                            </div>
                        )}
                      </div>
                  </div>
              </div>
          );
      };

      const SuggestionPill = ({ icon: Icon, text, onClick }) => (
        <button onClick={onClick} className="flex items-center gap-2 px-4 py-3 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 rounded-full shadow-sm transition-all group w-full justify-center">
            <Icon className="w-4 h-4 text-slate-400 group-hover:text-slate-600" />
            <span className="text-sm font-medium text-slate-600 group-hover:text-slate-900 truncate">{text}</span>
        </button>
      );

      const PromptTemplateModal = ({ isOpen, onClose, onSelect }) => {
          if(!isOpen) return null;
          const templates = [
              { name: "Summarize Document", prompt: "Summarize this text in 3 concise bullet points:", icon: TextIcon },
              { name: "Fix My Code", prompt: "Debug this code, explain the error, and provide the fixed version:", icon: CodeIcon },
              { name: "Write Professional Email", prompt: "Write a polite and professional email about:", icon: SendIcon },
              { name: "Simplify Complex Topic", prompt: "Explain this concept like I'm 10 years old:", icon: SparklesIcon },
              { name: "Creative Story", prompt: "Write a short story with a massive plot twist about:", icon: PaletteIcon }
          ];

          return (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4" onClick={onClose}>
                  <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in-up" onClick={e => e.stopPropagation()}>
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-lg font-bold text-slate-800">Quick Templates</h3>
                          <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-100"><CloseIcon className="w-5 h-5 text-slate-500"/></button>
                      </div>
                      <div className="grid gap-3">
                          {templates.map((t, i) => (
                              <button key={i} onClick={() => onSelect(t.prompt)} className="flex items-center gap-4 p-3 rounded-xl hover:bg-slate-50 border border-transparent hover:border-slate-200 transition-all text-left group">
                                  <div className="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:bg-indigo-100 transition-colors">
                                      <t.icon className="w-5 h-5" />
                                  </div>
                                  <div>
                                      <div className="font-semibold text-slate-800 text-sm">{t.name}</div>
                                      <div className="text-xs text-slate-500 truncate">{t.prompt}</div>
                                  </div>
                              </button>
                          ))}
                      </div>
                  </div>
              </div>
          )
      };

      const ImageGenerationModal = ({ isOpen, onClose, onGenerate }) => {
        const [prompt, setPrompt] = useState("");
        const inputRef = useRef(null);
        
        useEffect(() => {
            if(isOpen && inputRef.current) inputRef.current.focus();
        }, [isOpen]);

        if (!isOpen) return null;

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4" onClick={onClose}>
                <div className="bg-white rounded-3xl w-full max-w-lg p-6 shadow-2xl animate-fade-in-up border border-slate-100" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6">
                         <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                <PaletteIcon className="w-5 h-5" />
                            </div>
                            <div>
                                <h3 className="text-lg font-bold text-slate-900 leading-tight">Hyper-Real Studio</h3>
                                <p className="text-xs text-slate-500">Powered by Imagen 3 Quantum</p>
                            </div>
                         </div>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-slate-100 transition-colors"><CloseIcon className="w-5 h-5 text-slate-400"/></button>
                    </div>
                    
                    <div className="relative mb-6">
                        <textarea 
                            ref={inputRef}
                            className="w-full bg-slate-50 rounded-2xl p-4 text-slate-800 placeholder-slate-400 outline-none border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all resize-none h-32 text-base leading-relaxed"
                            placeholder="Describe your imagination in detail... (e.g., A futuristic city with neon lights in rain, 8k realism)"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                        />
                         <div className="absolute bottom-3 right-3 text-xs text-slate-400 font-medium">
                            {prompt.length} chars
                        </div>
                    </div>

                    <div className="flex justify-end gap-3">
                         <button onClick={onClose} className="px-5 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-50 transition-colors">Cancel</button>
                         <button 
                            onClick={() => { onGenerate(prompt); onClose(); setPrompt(""); }} 
                            disabled={!prompt.trim()}
                            className="px-6 py-2.5 rounded-xl bg-slate-900 text-white font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
                         >
                            <SparklesIcon className="w-4 h-4 text-yellow-300" />
                            Generate Masterpiece
                         </button>
                    </div>
                </div>
            </div>
        );
      };

      const App = () => {
          const [isSignedIn, setIsSignedIn] = useState(false);
          const [user, setUser] = useState(null);
          const [isLoaded, setIsLoaded] = useState(false);
          
          const [chatbotName, setChatbotName] = useState('');
          const [isSetupComplete, setIsSetupComplete] = useState(false);

          const [sessions, setSessions] = useState([]);
          const [activeId, setActiveId] = useState(null);
          const [input, setInput] = useState('');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [isStreaming, setIsStreaming] = useState(false);
          const [selectedImage, setSelectedImage] = useState(null);
          const [isProMode, setIsProMode] = useState(false);
          const [isDataLoaded, setIsDataLoaded] = useState(false);
          const [isMagicLoading, setIsMagicLoading] = useState(false);
          const [isMagicActive, setIsMagicActive] = useState(false);
          const [toastMessage, setToastMessage] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [engineStatus, setEngineStatus] = useState('');

          const [projects, setProjects] = useState(['General', 'Work', 'Creative']);
          const [activeProject, setActiveProject] = useState('General');

          const [showTemplates, setShowTemplates] = useState(false);
          const [showImageGenModal, setShowImageGenModal] = useState(false);

          const chatRef = useRef(null);
          const inputRef = useRef(null);
          const fileInputRef = useRef(null);
          const isMagicActiveRef = useRef(isMagicActive);

          useEffect(() => { isMagicActiveRef.current = isMagicActive; }, [isMagicActive]);

          useEffect(() => {
              const timer = setTimeout(() => {
                try {
                    const storedAuth = localStorage.getItem('bapkam_auth_token');
                    if (storedAuth) {
                        setIsSignedIn(true);
                        setUser({ id: 'guest_user', firstName: 'Friend' });
                    }
                } catch(e) { console.debug("Storage access error", e); }
                setIsLoaded(true);
              }, 800);
              return () => clearTimeout(timer);
          }, []);
          
          useEffect(() => {
              if (isLoaded && isSignedIn && user) {
                  try {
                      const savedName = localStorage.getItem(`bapkam_bot_name_${user.id}`);
                      if (savedName) {
                          setChatbotName(savedName);
                          setIsSetupComplete(true);
                      }

                      const savedChats = localStorage.getItem(`bapkam_chats_${user.id}`);
                      if (savedChats) {
                          const parsed = JSON.parse(savedChats);
                          setSessions(parsed);
                          setActiveId(parsed[0]?.id || null);
                      } else {
                          setSessions([]);
                      }
                  } catch(e) { console.debug("Storage load error", e); setSessions([]); }
                  setIsDataLoaded(true);
              }
          }, [isLoaded, isSignedIn, user]);

          useEffect(() => {
             if (isDataLoaded && isSignedIn && sessions.length === 0) {
                 createSession();
             }
          }, [isDataLoaded, isSignedIn]);

          useEffect(() => {
              if (isSignedIn && user && isDataLoaded) {
                  try {
                    localStorage.setItem(`bapkam_chats_${user.id}`, JSON.stringify(sessions));
                  } catch(e) {}
              }
          }, [sessions, isSignedIn, user, isDataLoaded]);

          useEffect(() => { if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight; }, [sessions, isStreaming]);

          useEffect(() => {
             if (isMagicActive && input.trim() && !isMagicLoading && isProMode) {
                 const timer = setTimeout(() => {
                     if (input.trim() && isMagicActive) {
                         handleEnhancePrompt();
                     }
                 }, 1500); 
                 return () => clearTimeout(timer);
             }
          }, [input, isMagicActive, isProMode]);

          useEffect(() => {
            if (toastMessage) {
                const timer = setTimeout(() => setToastMessage(null), 3000);
                return () => clearTimeout(timer);
            }
          }, [toastMessage]);

          const showToast = (msg) => setToastMessage(msg);

          const handleLogin = (e) => {
              e.preventDefault(); 
              try { localStorage.setItem('bapkam_auth_token', 'guest_access_granted'); } catch(e) {}
              setIsSignedIn(true);
              setUser({ id: 'guest_user', firstName: 'Friend' });
          };

          const handleLogout = () => {
              try { localStorage.removeItem('bapkam_auth_token'); } catch(e) {}
              setIsSignedIn(false);
              setUser(null);
              setSessions([]);
              setIsSetupComplete(false);
          };

          const currentSession = sessions.find(s => s.id === activeId) || { messages: [] };

          const createSession = (project = 'General') => {
              const id = Date.now().toString();
              const newSession = { id, title: 'New Chat', messages: [], project: project };
              setSessions(prev => [newSession, ...prev]);
              setActiveId(id);
              setActiveProject(project);
              if (window.innerWidth < 1024) setIsSidebarOpen(false);
          };
          
          const handleDeleteSession = (e, sessionId) => {
            e.stopPropagation();
            const newSessions = sessions.filter(s => s.id !== sessionId);
            setSessions(newSessions);
            
            if (newSessions.length === 0) {
                const id = Date.now().toString();
                const newSession = { id, title: 'New Chat', messages: [], project: activeProject };
                setSessions([newSession]);
                setActiveId(id);
            } else if (activeId === sessionId) {
                setActiveId(newSessions[0].id);
            }
          };

          const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => setSelectedImage(reader.result);
                reader.readAsDataURL(file);
            }
          };

          const handleBotSetup = (name) => {
              if (!name.trim()) return;
              try { localStorage.setItem(`bapkam_bot_name_${user.id}`, name); } catch(e) {}
              setChatbotName(name);
              setIsSetupComplete(true);
              createSession();
          };

          const handleToggleMagic = () => {
             if (!isProMode) {
                 showToast("Turn on Pro Mode to use this feature.");
                 return;
             }
             setIsMagicActive(!isMagicActive);
          };

          const handleTogglePro = () => {
              setIsProMode(!isProMode);
          };

          const handleEnhancePrompt = async () => {
              if (!input.trim()) return;
              setIsMagicLoading(true);
              try {
                  const key = typeof process !== 'undefined' ? process.env.API_KEY : '';
                  const ai = new GoogleGenAI({ apiKey: key || 'dummy_key' });
                  
                  const response = await ai.models.generateContent({
                      model: 'gemini-2.5-flash',
                      contents: input,
                      config: {
                          systemInstruction: "You are an APEX PROMPT ENGINEER. Rewrite input to be concise, professional and 'God-Tier'. Output ONLY the prompt.",
                          temperature: 0.7 
                      }
                  });

                  if (!isMagicActiveRef.current) return;
                  if (!inputRef.current || inputRef.current.value === '') return;
                  if (response.text) setInput(response.text.trim());
              } catch (e) {
                  console.debug("Magic Wand suppressed error", e);
              } finally {
                  setIsMagicLoading(false);
              }
          };

          const handleGenerateRealImage = async (promptOverride = null) => {
              const textToUse = promptOverride || input;
              if (!textToUse.trim()) {
                  setShowImageGenModal(true);
                  return;
              }
              
              setIsStreaming(true);
              setInput(''); 

              const userMsg = { role: 'user', content: `Generate Hyper-Real Image: ${textToUse}` };
              let updatedSessions = sessions.map(s => s.id === activeId ? { ...s, messages: [...s.messages, userMsg] } : s);
              setSessions(updatedSessions);
              
              const updateStatus = (msg) => {
                  setSessions(prev => prev.map(s => s.id === activeId ? { 
                      ...s, 
                      messages: s.messages.map((m, i) => i === s.messages.length - 1 ? { ...m, statusMessage: msg } : m)
                  } : s));
              };

              setSessions(prev => prev.map(s => s.id === activeId ? { ...s, messages: [...s.messages, { role: 'model', content: '', statusMessage: 'Initializing Quantum Engine...' }] } : s));

              try {
                  const key = typeof process !== 'undefined' ? process.env.API_KEY : '';
                  const ai = new GoogleGenAI({ apiKey: key || 'dummy_key' });

                  updateStatus('Deep Logic Analysis: Architecting Composition...');
                  const analysisResponse = await ai.models.generateContent({
                      model: 'gemini-2.5-flash',
                      contents: `Rewrite this image prompt for 8K Photorealism: "${textToUse}". Output ONLY the prompt.`,
                  });
                  const enhancedPrompt = analysisResponse.text || textToUse;
                  
                  updateStatus('Multi-Engine Synthesis: Optimizing Visuals...');
                  let imageUri = null;
                  let usedPrompt = enhancedPrompt;

                  try {
                       updateStatus('Imagen 3 Quantum: Rendering 8K Visuals...');
                       const imagenResponse = await ai.models.generateImages({
                            model: 'imagen-3.0-generate-001',
                            prompt: enhancedPrompt,
                            config: { numberOfImages: 1, aspectRatio: "16:9" }
                       });
                       if (imagenResponse.generatedImages?.[0]?.image?.imageBytes) {
                           imageUri = `data:image/jpeg;base64,${imagenResponse.generatedImages[0].image.imageBytes}`;
                           usedPrompt = enhancedPrompt + " (Generated with Imagen 3)";
                       } else throw new Error("No data");
                  } catch (imagenError) {
                      try {
                           updateStatus('Gemini Vision Pro: Rerouting...');
                           const imgResponse = await ai.models.generateContent({
                                model: 'gemini-3-pro-image-preview',
                                contents: { parts: [{ text: enhancedPrompt }] },
                                config: { imageConfig: { aspectRatio: "16:9" } }
                           });
                           for (const part of imgResponse.candidates[0].content.parts) {
                               if (part.inlineData) {
                                   imageUri = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                                    usedPrompt = enhancedPrompt + " (Generated with Gemini 3 Pro)";
                               }
                           }
                      } catch (proError) {
                          try {
                              updateStatus('Fast Engine: Finalizing Render...');
                              const fallbackResponse = await ai.models.generateContent({
                                model: 'gemini-2.5-flash-image',
                                contents: { parts: [{ text: textToUse }] },
                                config: { imageConfig: { aspectRatio: "16:9" } }
                              });
                              for (const part of fallbackResponse.candidates[0].content.parts) {
                                  if (part.inlineData) {
                                      imageUri = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                                      usedPrompt = textToUse + " (Generated with Fast Engine)";
                                  }
                              }
                          } catch (fallbackError) { throw new Error("All image models failed."); }
                      }
                  }

                   if (imageUri) {
                        setSessions(prev => prev.map(s => s.id === activeId ? { 
                            ...s, 
                            messages: [...s.messages.slice(0, -1), { role: 'model', content: usedPrompt, images: [imageUri] }] 
                        } : s));
                   } else throw new Error("Image generation failed.");

              } catch (e) {
                  setSessions(prev => prev.map(s => s.id === activeId ? { ...s, messages: s.messages.slice(0, -1) } : s));
                  showToast("Connection interrupted. Visual generation paused.");
              } finally {
                  setIsStreaming(false);
              }
          };

          const handleSend = async (textOverride = null) => {
              const textToSend = textOverride || input;
              if ((!textToSend.trim() && !selectedImage) || isStreaming) return;
              
              const imagePayload = selectedImage;

              setInput(''); setSelectedImage(null); setIsStreaming(true);
              setIsMagicActive(false); 
              isMagicActiveRef.current = false; 
              
              if (isProMode) {
                  const engines = [
                      "âš¡ Deep Logic: Analyzing Complexity...",
                      "ðŸ§  Creative Engine: Synthesizing Tone...",
                      "ðŸ“š Knowledge Base: Fact Checking...",
                      "âœ¨ Formatting Core: Polishing Output...",
                      "ðŸš€ Generating Final Response..."
                  ];
                  let i = 0;
                  setEngineStatus(engines[0]);
                  const interval = setInterval(() => {
                      i++;
                      if (i < engines.length) setEngineStatus(engines[i]);
                      else { clearInterval(interval); setEngineStatus(''); }
                  }, 800);
              }

              const userMsg = { role: 'user', content: textToSend, images: imagePayload ? [imagePayload] : [] };
              let newTitle = currentSession.title === 'New Chat' ? (textToSend ? textToSend.substring(0, 30) : 'New Analysis') : currentSession.title;

              let updatedSessions = sessions.map(s => s.id === activeId ? { ...s, messages: [...s.messages, userMsg], title: newTitle } : s);
              updatedSessions = updatedSessions.map(s => s.id === activeId ? { ...s, messages: [...s.messages, { role: 'model', content: '', isPro: isProMode, botName: chatbotName }] } : s);
              setSessions(updatedSessions);

              const historyParts = currentSession.messages
                  .filter(m => !m.statusMessage)
                  .map(m => {
                      const parts = [];
                      if (m.images && m.images.length > 0) {
                          m.images.forEach(img => {
                              try {
                                  if (img.includes('base64,')) {
                                      parts.push({ inlineData: { mimeType: 'image/jpeg', data: img.split('base64,')[1] } });
                                  }
                              } catch(e) {}
                          });
                      }
                      if (m.content) parts.push({ text: m.content });
                      return parts.length > 0 ? { role: m.role === 'user' ? 'user' : 'model', parts: parts } : null;
                  })
                  .filter(Boolean);

              const currentParts = [];
              if (imagePayload) {
                   try {
                       currentParts.push({ inlineData: { mimeType: 'image/jpeg', data: imagePayload.split('base64,')[1] } });
                   } catch(e) {}
              }
              currentParts.push({ text: textToSend });
              const finalContents = [...historyParts, { role: 'user', parts: currentParts }];

              const botIdentity = chatbotName || "Bapkam";
              const baseIdentity = `You are Bapkam, created by Arvind and Afridi. Friendly, concise, helpful.`;
              const proInstructions = `You are running in PRO MODE. Act as a consensus of expert engines. Combine 'Deep Logic' (for accuracy), 'Creative Spirit' (for engaging writing), and 'Formatting Core' (to structure the answer beautifully with markdown). Your goal is to provide an answer that is excellent, attractive, and highly comprehensive.`;
              
              const systemPrompt = isProMode ? baseIdentity + "\n" + proInstructions : baseIdentity;

              try {
                  const key = typeof process !== 'undefined' ? process.env.API_KEY : '';
                  if (!key) throw new Error("API Key missing");
                  
                  const ai = new GoogleGenAI({ apiKey: key });

                  // ROBUST RETRY & FALLBACK LOOP
                  let attempts = 0;
                  const maxAttempts = 3;

                  while (attempts < maxAttempts) {
                      try {
                          const config = {
                              systemInstruction: systemPrompt,
                              temperature: isProMode ? 0.6 : 0.7,
                          };
                          // Only add complex configs if attempting Pro Mode features
                          if (isProMode && attempts === 0) {
                              config.tools = [{ googleSearch: {} }];
                              config.thinkingConfig = { thinkingBudget: 1024 };
                          }
                          
                          const streamResult = await ai.models.generateContentStream({
                              model: 'gemini-2.5-flash',
                              contents: finalContents, 
                              config: config
                          });
                          
                          let assistantText = '';
                          for await (const chunk of streamResult) {
                              const chunkText = chunk.text;
                              if (chunkText) {
                                  assistantText += chunkText;
                                  setSessions(prev => prev.map(s => s.id === activeId ? { ...s, messages: [...s.messages.slice(0, -1), { role: 'model', content: assistantText, isPro: isProMode, botName: botIdentity }] } : s));
                              }
                          }
                          break; // Success
                      } catch (err) {
                          attempts++;
                          console.warn(`Attempt ${attempts} failed.`, err);
                          
                          if (attempts >= maxAttempts) throw err;
                          
                          // Smart Fallback: Disable Pro tools on retry for stability
                          if (attempts === 1) {
                              // Fast retry without tools
                              await new Promise(r => setTimeout(r, 500));
                          } else {
                              // Slower retry
                              await new Promise(r => setTimeout(r, 1000));
                          }
                      }
                  }
              } catch (error) {
                  setSessions(prev => prev.map(s => s.id === activeId ? { ...s, messages: s.messages.slice(0, -1) } : s));
                  showToast("Network is struggling. Please try again.");
                  console.error("Critical AI Error:", error);
              } finally { 
                  setIsStreaming(false); 
                  setEngineStatus('');
              }
          };
          
          const filteredSessions = sessions.filter(s => s.title.toLowerCase().includes(searchQuery.toLowerCase()));

          if (!isLoaded) return <div className="h-full w-full flex items-center justify-center bg-white"><RainbowCyclone className="w-10 h-10" /></div>;

          if (!isSignedIn) {
              return (
                  <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-slate-50 relative overflow-hidden font-sans">
                      <div className="absolute top-0 left-0 w-[500px] h-[500px] bg-slate-100 rounded-full blur-3xl opacity-40 -translate-x-1/2 -translate-y-1/2 animate-pulse-slow"></div>
                      <div className="absolute bottom-0 right-0 w-[500px] h-[500px] bg-slate-200 rounded-full blur-3xl opacity-40 translate-x-1/2 translate-y-1/2 animate-pulse-slow"></div>
                      <div className="z-10 bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-fade-in-up">
                          <div className="flex flex-col items-center mb-6">
                                <div className="w-20 h-20 mb-4 bg-white border border-slate-100 rounded-[1.5rem] shadow-xl flex items-center justify-center ring-1 ring-slate-900/5">
                                    <BapkamLogo className="w-12 h-12" />
                                </div>
                                <h1 className="text-3xl font-bold text-slate-900">bapkam.ai</h1>
                                <p className="text-slate-500 mt-2 text-center">Created by Arvind and Afridi</p>
                          </div>
                          <button onClick={handleLogin} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-semibold hover:bg-black transition-colors shadow-lg flex items-center justify-center gap-2 group"><span>Get Started</span><span className="group-hover:translate-x-1 transition-transform">â†’</span></button>
                      </div>
                  </div>
              );
          }

          if (isSignedIn && !isSetupComplete) {
              return (
                <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-slate-50 font-sans">
                     <div className="z-10 bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100 animate-fade-in-up text-center">
                        <h2 className="text-xl font-semibold text-slate-800">Name Your AI</h2>
                        <p className="text-slate-500 text-sm mb-6">What should we call your personal assistant?</p>
                        <form onSubmit={(e) => { e.preventDefault(); handleBotSetup(e.target.elements.name.value); }}>
                            <input name="name" type="text" className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-center font-bold text-lg mb-4" placeholder="e.g. Jarvis, Friday, Bapkam" autoFocus />
                            <button type="submit" className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-semibold hover:bg-black transition-colors shadow-lg">Complete Setup</button>
                        </form>
                    </div>
                </div>
              );
          }
          
          const isNewChat = currentSession.messages.length === 0;
          return (
              <div className={`flex h-full w-full font-sans transition-colors duration-700 ${isProMode ? 'bg-[#f8f9fa]' : 'bg-white'}`}>
                  {isSidebarOpen && <div className="fixed inset-0 bg-black/20 z-30 lg:hidden backdrop-blur-md" onClick={() => setIsSidebarOpen(false)}></div>}
                  <aside className={`fixed lg:relative inset-y-0 left-0 w-[280px] bg-white border-r border-slate-200 z-40 transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 flex flex-col`}>
                      <div className="p-4 flex items-center justify-between border-b border-slate-100/50">
                          <div className="flex items-center gap-3 font-bold text-lg text-slate-800 tracking-tight">
                              <div className="w-8 h-8 bg-white border border-slate-100 rounded-lg flex items-center justify-center shadow-sm">
                                  <BapkamLogo className="w-5 h-5" isPro={isProMode} />
                              </div>
                              {chatbotName}
                          </div>
                          <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden p-2 hover:bg-slate-100 rounded-full transition-colors"><CloseIcon className="w-5 h-5 text-slate-500"/></button>
                      </div>
                      
                      <div className="px-4 mt-3">
                          <div className="relative">
                              <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"/>
                              <input type="text" placeholder="Search History..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-1 focus:ring-slate-300"/>
                          </div>
                      </div>
                      
                      <div className="px-4 mt-4">
                        <div className={`flex items-center justify-between p-3 rounded-xl border transition-all duration-300 ${isProMode ? 'bg-slate-900 border-slate-800 text-white' : 'bg-white border-slate-200 text-slate-800'}`}>
                            <div className="flex items-center gap-3">
                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center transition-colors ${isProMode ? 'bg-slate-800 text-green-400' : 'bg-slate-100 text-slate-500'}`}><ZapIcon className="w-4 h-4" /></div>
                                <div className="flex flex-col"><span className="text-sm font-bold">Pro Mode</span></div>
                            </div>
                            <button onClick={handleTogglePro} className={`w-10 h-6 rounded-full p-1 transition-colors relative ${isProMode ? 'bg-green-500' : 'bg-slate-200'}`}>
                                <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300 ${isProMode ? 'translate-x-4' : 'translate-x-0'}`}></div>
                            </button>
                        </div>
                      </div>

                      {isProMode && (
                        <div className="px-4 mt-2 space-y-1 animate-fade-in">
                            <button onClick={() => handleGenerateRealImage()} className="w-full flex items-center gap-2 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-200">
                                <div className="w-6 h-6 rounded bg-indigo-50 text-indigo-600 flex items-center justify-center"><PaletteIcon className="w-3.5 h-3.5"/></div>
                                Hyper-Real Image
                            </button>
                            <button onClick={handleToggleMagic} className={`w-full flex items-center gap-2 px-3 py-2 text-xs font-semibold rounded-lg transition-colors border border-transparent ${isMagicActive ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'text-slate-600 hover:bg-slate-50 hover:border-slate-200'}`}>
                                <div className={`w-6 h-6 rounded flex items-center justify-center ${isMagicActive ? 'bg-indigo-200 text-indigo-700' : 'bg-orange-50 text-orange-600'}`}><MagicWandIcon className="w-3.5 h-3.5"/></div>
                                {isMagicActive ? 'Magic Prompt On' : 'Magic Prompt'}
                            </button>
                        </div>
                      )}

                      <div className="px-4 mt-4 mb-2">
                           <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Project Spaces</div>
                           <div className="flex gap-1 overflow-x-auto pb-2 scrollbar-hide">
                               {projects.map(p => (
                                   <button key={p} onClick={() => { setActiveProject(p); createSession(p); }} className={`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap transition-colors ${activeProject === p ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{p}</button>
                               ))}
                           </div>
                      </div>

                      <div className="px-4 pb-4"><button onClick={() => createSession(activeProject)} className="w-full flex items-center gap-3 px-4 py-3 bg-white border border-slate-200 hover:border-indigo-300 hover:shadow-md rounded-xl transition-all text-sm font-semibold text-slate-700 group"><div className="bg-indigo-50 text-indigo-600 p-1.5 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors"><PlusIcon className="w-4 h-4"/></div>New Chat</button></div>
                      
                      <div className="flex-1 overflow-y-auto px-2 custom-scroll space-y-0.5">
                          {filteredSessions.map(s => (
                              <div key={s.id} className={`group relative w-full rounded-lg transition-all ${activeId===s.id ? 'bg-slate-100' : 'hover:bg-slate-50'}`}>
                                  <button onClick={() => { setActiveId(s.id); if(window.innerWidth<1024) setIsSidebarOpen(false); }} className={`w-full text-left px-4 py-3 pr-10 rounded-lg text-sm truncate transition-all ${activeId===s.id ? 'text-slate-900 font-medium' : 'text-slate-600'}`}>{s.title}</button>
                                  <button onClick={(e) => handleDeleteSession(e, s.id)} className={`absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-md text-slate-400 hover:text-red-500 hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-opacity ${activeId===s.id ? 'opacity-100' : ''}`} title="Delete Chat"><TrashIcon className="w-4 h-4" /></button>
                              </div>
                          ))}
                      </div>
                      
                      <div className="p-4 border-t border-slate-100">
                          <div className="flex items-center justify-between w-full p-2 rounded-xl bg-slate-50 border border-slate-100">
                              <div className="flex items-center gap-3">
                                  <div className="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center font-bold text-xs">{user?.firstName?.charAt(0) || 'F'}</div>
                                  <div className="flex flex-col"><span className="text-sm font-bold text-slate-800">{user?.firstName || 'Friend'}</span><span className="text-[10px] text-slate-500">Free Plan</span></div>
                              </div>
                              <button onClick={handleLogout} className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Sign Out"><LogOutIcon className="w-4 h-4" /></button>
                          </div>
                      </div>
                  </aside>

                  <main className="flex-1 flex flex-col h-full relative min-w-0 bg-[#ffffff]">
                      <header className={`h-14 lg:h-16 flex items-center justify-between px-4 lg:px-6 sticky top-0 z-20 backdrop-blur-md transition-colors duration-500 bg-white/90 border-b border-transparent`}>
                          <div className="flex items-center gap-3">
                              <button onClick={() => setIsSidebarOpen(true)} className={`lg:hidden p-2 -ml-2 rounded-lg hover:bg-slate-100 text-slate-700`}><MenuIcon className="w-6 h-6"/></button>
                              <span className={`font-bold text-lg lg:hidden text-slate-800`}>{chatbotName}</span>
                          </div>
                          <div className={`hidden lg:flex items-center gap-2.5 px-4 py-1.5 rounded-full border shadow-sm transition-all ${isProMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                              <span className={`w-2 h-2 rounded-full ${isProMode ? 'bg-green-400' : 'bg-slate-400'}`}></span>
                              <span className={`font-medium text-xs tracking-wide ${isProMode ? 'text-white' : 'text-slate-600'}`}>{isProMode ? 'PRO MODE ACTIVE' : 'Standard Mode'}</span>
                          </div>
                      </header>
                      
                      <div className="flex-1 overflow-y-auto custom-scroll scroll-smooth p-0 relative z-10" ref={chatRef}>
                          {isNewChat ? (
                              <div className="max-w-2xl mx-auto flex flex-col items-center justify-center min-h-[60vh] animate-fade-in-up px-4 sm:px-6">
                                  <div className="mb-4 transform scale-125"><BapkamLogo className="w-16 h-16" isPro={isProMode} /></div>
                                  <h2 className="text-4xl font-bold text-slate-900 mb-6 text-center tracking-tight">bapkam</h2>
                                  <div className="w-full max-w-lg space-y-3">
                                      <div className="flex gap-3">
                                          <SuggestionPill icon={SearchIcon} text="Deep Search" onClick={() => handleSend("Research deeply about:")} />
                                          <SuggestionPill icon={PaletteIcon} text="Create Image" onClick={() => setShowImageGenModal(true)} />
                                      </div>
                                      <div className="flex justify-center"><div className="w-1/2"><SuggestionPill icon={TemplateIcon} text="Templates" onClick={() => setShowTemplates(true)} /></div></div>
                                  </div>
                                  <div className="mt-12 text-slate-400 text-sm">{isProMode ? 'Pro Reasoning Active' : 'Ready to create something extraordinary?'}</div>
                              </div>
                          ) : (
                              <div className="max-w-4xl mx-auto py-6 space-y-6 px-4 sm:px-6 pb-24">
                                {currentSession.messages.map((m, i) => <ChatMessage key={i} msg={m} isPro={m.isPro} isLatest={i === currentSession.messages.length - 1} isLoading={isStreaming} botName={chatbotName} />)}
                              </div>
                          )}
                      </div>

                      <div className={`p-4 lg:p-6 transition-all duration-500 z-20 bg-white/90 backdrop-blur-md`}>
                          <div className={`max-w-2xl mx-auto relative flex flex-col items-stretch gap-2 bg-slate-50 border shadow-sm rounded-[24px] p-1.5 transition-all focus-within:ring-2 focus-within:ring-slate-100 ${isProMode ? 'border-indigo-200' : 'border-slate-200'}`}>
                              {/* Engine Status Indicator for Pro Mode */}
                              {engineStatus && (
                                  <div className="absolute -top-7 left-0 w-full flex justify-center animate-fade-in">
                                      <div className="bg-gradient-to-r from-indigo-600 to-violet-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg flex items-center gap-1.5">
                                          <span className="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                                          {engineStatus}
                                      </div>
                                  </div>
                              )}
                              <div className="flex items-end gap-2">
                                  <button onClick={() => fileInputRef.current.click()} className="p-2.5 rounded-full hover:bg-slate-200 text-slate-400 transition-colors"><PaperclipIcon className="w-5 h-5" /></button>
                                  <div className="flex-1 flex flex-col justify-center min-h-[40px]">
                                       {selectedImage && (
                                          <div className="flex items-center gap-2 mb-1 p-1 bg-white rounded-lg w-fit border border-slate-200">
                                              <img src={selectedImage} className="w-8 h-8 object-cover rounded-md" />
                                              <button onClick={() => setSelectedImage(null)} className="p-0.5 hover:bg-slate-100 rounded-full"><CloseIcon className="w-3 h-3 text-slate-500"/></button>
                                          </div>
                                       )}
                                       <textarea ref={inputRef} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} placeholder={isProMode ? "Ask Deep Research..." : "Message bapkam..."} className={`w-full bg-transparent outline-none resize-none max-h-32 text-slate-800 placeholder-slate-400 py-2 px-1 text-sm ${isMagicActive ? 'text-indigo-700 font-medium' : ''}`} rows={1} style={{ height: 'auto', minHeight: '24px' }} onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }} />
                                  </div>
                                  {isMagicLoading && <div className="absolute right-14 bottom-3"><RainbowCyclone className="w-4 h-4 opacity-50" /></div>}
                                  <button onClick={() => handleSend()} disabled={!input.trim() && !selectedImage} className={`p-2.5 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed ${input.trim() || selectedImage ? 'bg-black text-white' : 'bg-slate-200 text-slate-400'}`}>{isStreaming ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <SendIcon className="w-5 h-5" />}</button>
                              </div>
                          </div>
                          <div className="text-center mt-3">
                              <p className="text-[10px] text-slate-400">By messaging bapkam.ai, you agree to our <a href="#" className="underline hover:text-slate-600">Terms</a> and <a href="#" className="underline hover:text-slate-600">Privacy Policy</a>.</p>
                          </div>
                      </div>

                      <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                      <PromptTemplateModal isOpen={showTemplates} onClose={() => setShowTemplates(false)} onSelect={(txt) => { setInput(txt); setShowTemplates(false); inputRef.current.focus(); }} />
                      <ImageGenerationModal isOpen={showImageGenModal} onClose={() => setShowImageGenModal(false)} onGenerate={handleGenerateRealImage} />
                      {toastMessage && <div className="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full shadow-xl backdrop-blur-md z-[60] text-sm font-medium animate-fade-in-up flex items-center gap-2"><SparklesIcon className="w-4 h-4 text-yellow-400" />{toastMessage}</div>}
                  </main>
              </div>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
            <App />
        </ErrorBoundary>
      );
    </script>
  </body>
</html>